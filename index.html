<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BTC/USDT — Market Overview (Free Data)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  
  :root{
    --bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
    --surface: rgba(23, 26, 33, 0.8);
    --surface-hover: rgba(30, 35, 45, 0.9);
    --border: rgba(56, 68, 77, 0.3);
    --border-hover: rgba(56, 68, 77, 0.6);
    --text: #e6e8eb;
    --text-secondary: #9aa0a6;
    --ok: #10b981;
    --warn: #f59e0b;
    --bad: #ef4444;
    --accent: #3b82f6;
    --accent-secondary: #8b5cf6;
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --card-shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.4);
    --glow: 0 0 20px rgba(59, 130, 246, 0.3);
  }
  @media (prefers-color-scheme: light){
    :root{ 
      --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --surface: rgba(255, 255, 255, 0.9);
      --surface-hover: rgba(248, 250, 252, 1);
      --border: rgba(226, 232, 240, 0.8);
      --border-hover: rgba(148, 163, 184, 0.6);
      --text: #1e293b;
      --text-secondary: #64748b;
      --card-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
      --card-shadow-hover: 0 12px 48px rgba(15, 23, 42, 0.12);
      --glow: 0 0 20px rgba(59, 130, 246, 0.2);
    }
  }
  html[data-theme="light"]{
    --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    --surface: rgba(255, 255, 255, 0.9);
    --surface-hover: rgba(248, 250, 252, 1);
    --border: rgba(226, 232, 240, 0.8);
    --border-hover: rgba(148, 163, 184, 0.6);
    --text: #1e293b;
    --text-secondary: #64748b;
    --card-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
    --card-shadow-hover: 0 12px 48px rgba(15, 23, 42, 0.12);
    --glow: 0 0 20px rgba(59, 130, 246, 0.2);
  }
  html[data-theme="dark"]{
    --bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
    --surface: rgba(23, 26, 33, 0.8);
    --surface-hover: rgba(30, 35, 45, 0.9);
    --border: rgba(56, 68, 77, 0.3);
    --border-hover: rgba(56, 68, 77, 0.6);
    --text: #e6e8eb;
    --text-secondary: #9aa0a6;
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --card-shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.4);
    --glow: 0 0 20px rgba(59, 130, 246, 0.3);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    font-weight:400;line-height:1.6;min-height:100vh;overflow-x:hidden;
  }
  body::before{
    content:'';position:fixed;inset:0;
    background:
      radial-gradient(circle at 20% 80%, rgba(59,130,246,.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(139,92,246,.1) 0%, transparent 50%);
    pointer-events:none;z-index:-1;
  }
  .wrap{max-width:1400px;margin:0 auto;padding:24px 20px;position:relative}
  .brand{display:flex;gap:16px;justify-content:space-between;align-items:center;margin:0 0 32px;padding:24px 0;border-bottom:1px solid var(--border)}
  .brand h1{margin:0;font-size:clamp(24px,4vw,32px);font-weight:700;background:linear-gradient(135deg,var(--accent) 0%,var(--accent-secondary) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .me{color:var(--warn);font-weight:600;font-size:14px;padding:8px 16px;background:rgba(245,158,11,.1);border-radius:20px;border:1px solid rgba(245,158,11,.2)}
  .btn{background:var(--surface);backdrop-filter:blur(10px);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 16px;cursor:pointer;box-shadow:var(--card-shadow);font-weight:500;font-size:14px;transition:.3s;position:relative;overflow:hidden}
  .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);transition:left .5s}
  .btn:hover::before{left:100%}
  .btn:hover{background:var(--surface-hover);border-color:var(--border-hover);box-shadow:var(--card-shadow-hover);transform:translateY(-2px)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .pill{padding:10px 20px;border:1px solid var(--border);border-radius:25px;background:var(--surface);backdrop-filter:blur(10px);font-weight:600;font-size:14px;box-shadow:var(--card-shadow);transition:.3s}
  .pill:hover{box-shadow:var(--glow);transform:translateY(-1px)}
  .muted{color:var(--text-secondary);font-size:13px;font-weight:500}
  .grid{display:grid;gap:24px;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));align-items:stretch;margin-bottom:32px}
  .card{background:var(--surface);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:20px;padding:24px;min-height:200px;display:flex;flex-direction:column;justify-content:space-between;box-shadow:var(--card-shadow);position:relative;transition:.4s;overflow:hidden}
  .card::before{content:'';position:absolute;left:0;right:0;top:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent-secondary));opacity:0;transition:.3s}
  .card:hover::before{opacity:1}
  .card:hover{background:var(--surface-hover);border-color:var(--border-hover);box-shadow:var(--card-shadow-hover);transform:translateY(-4px) scale(1.02)}
  .card h3{margin:0 0 16px;font-size:16px;font-weight:600;color:var(--text);letter-spacing:-.025em}
  .kv{display:flex;justify-content:space-between;gap:16px;margin:10px 0;align-items:center}
  .kv span:first-child{font-size:14px;color:var(--text-secondary);font-weight:500}
  .kv span:last-child{font-weight:600;color:var(--text)}
  .big{font-size:clamp(20px,3vw,28px);font-weight:800;letter-spacing:-.025em;background:linear-gradient(135deg,var(--text) 0%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .center{text-align:center}
  .ok{border-color:var(--ok);background:rgba(16,185,129,.05)} .ok::before{background:linear-gradient(90deg,var(--ok),#34d399)}
  .warn{border-color:var(--warn);background:rgba(245,158,11,.05)} .warn::before{background:linear-gradient(90deg,var(--warn),#fbbf24)}
  .bad{border-color:var(--bad);background:rgba(239,68,68,.05)} .bad::before{background:linear-gradient(90deg,var(--bad),#f87171)}
  .card[data-tip]::after{content:attr(data-tip);position:absolute;left:16px;right:16px;bottom:16px;background:rgba(0,0,0,.9);color:#fff;font-size:12px;line-height:1.4;padding:12px 16px;border-radius:12px;opacity:0;transform:translateY(8px);pointer-events:none;transition:.3s;backdrop-filter:blur(10px);z-index:10}
  html[data-theme="light"] .card[data-tip]::after{background:rgba(30,34,44,.95)}
  .card:hover::after{opacity:1;transform:translateY(0)}
  .chartWrap{background:var(--surface);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:20px;padding:24px;margin:0 0 32px;box-shadow:var(--card-shadow);transition:.3s;position:relative;overflow:hidden}
  .chartWrap::before{content:'';position:absolute;left:0;right:0;top:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent-secondary))}
  .chartWrap:hover{box-shadow:var(--card-shadow-hover);transform:translateY(-2px)}
  canvas#priceChart{width:100%;height:400px;display:block;border-radius:12px}
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border)}
  .toolbar .muted{font-weight:600}
  .gauge{width:100%;max-width:280px;margin:auto;filter:drop-shadow(0 4px 8px rgba(0,0,0,.1))}
  @media (max-width:768px){.wrap{padding:16px 12px}.brand{flex-direction:column;gap:16px;text-align:center}.row{justify-content:center}.grid{grid-template-columns:1fr;gap:16px}.card{padding:20px;min-height:180px}canvas#priceChart{height:300px}}
  @media (max-width:480px){.brand h1{font-size:24px}.btn,.pill{font-size:13px;padding:8px 12px}.card{padding:16px;border-radius:16px}.chartWrap{padding:16px;border-radius:16px}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}} .loading{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}
  html{scroll-behavior:smooth}
  ::-webkit-scrollbar{width:8px} ::-webkit-scrollbar-track{background:transparent} ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px} ::-webkit-scrollbar-thumb:hover{background:var(--border-hover)}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <h1>BTC/USDT — Market Overview</h1>
    <div class="row">
      <div class="pill" id="marketScore">Market Score: loading…</div>
      <button class="btn" id="toggleChartBtn">Hide chart</button>
      <button class="btn" id="refreshBtn">Refresh</button>
      <button class="btn" id="themeBtn" title="Toggle theme">Theme: Auto</button>
      <div class="me">Made by Anas Alwadi</div>
    </div>
  </div>

  <!-- Chart -->
  <div class="chartWrap" id="chartBox">
    <div class="toolbar">
      <div class="muted">BTC/USDT — last 180 days</div>
      <div class="muted" id="asofChart">Updating…</div>
    </div>
    <canvas id="priceChart" width="1080" height="340" aria-label="BTC price"></canvas>
  </div>

  <!-- Cards -->
  <div class="grid" id="grid"></div>
  <p class="muted" id="asof" style="margin-top:10px"></p>
</div>

<script>
const $ = s => document.querySelector(s);
const fmt = n => Number(n).toLocaleString();
const pct = x => (x==null||!isFinite(x)) ? "—" : (x*100).toFixed(2)+"%";
const bust = url => url + (url.includes("?")?"&":"?") + "t=" + Date.now();

// Theme toggle: auto / light / dark
function applyTheme(mode){
  const html = document.documentElement;
  if(mode==="auto"){ html.setAttribute("data-theme","auto"); }
  else if(mode==="light"){ html.setAttribute("data-theme","light"); }
  else { html.setAttribute("data-theme","dark"); }
  localStorage.setItem("themeMode", mode);
  $("#themeBtn").textContent = "Theme: " + mode[0].toUpperCase()+mode.slice(1);
}
(function initTheme(){ applyTheme(localStorage.getItem("themeMode") || "auto"); })();
$("#themeBtn").addEventListener("click", ()=>{
  const order=["auto","light","dark"];
  const cur = localStorage.getItem("themeMode") || "auto";
  const next = order[(order.indexOf(cur)+1)%order.length];
  applyTheme(next);
});

// Data sources
const CG_PRICE    = "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd";
const CG_GLOBAL   = "https://api.coingecko.com/api/v3/global";
const CG_COIN     = "https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false";
const CG_MKTCHART = "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=180&interval=daily";

const FNG         = "https://api.alternative.me/fng/?limit=2";

const BCH_HASH    = "https://api.blockchain.info/charts/hash-rate?timespan=60days&format=json&cors=true";
const BCH_DIFF    = "https://api.blockchain.info/charts/difficulty?timespan=60days&format=json&cors=true";
const BCH_ADDR    = "https://api.blockchain.info/charts/n-unique-addresses?timespan=60days&format=json&cors=true";
const BCH_TXV_USD = "https://api.blockchain.info/charts/estimated-transaction-volume-usd?timespan=180days&format=json&cors=true";
const BCH_FEES_USD= "https://api.blockchain.info/charts/transaction-fees-usd?timespan=60days&format=json&cors=true";

const MEMPOOL_FEES  = "https://mempool.space/api/v1/fees/recommended";
const MEMPOOL_STATS = "https://mempool.space/api/mempool";

async function getJSON(url){
  const r = await fetch(bust(url), {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
function SMA(arr, win){ const out=[]; let s=0; for(let i=0;i<arr.length;i++){ s+=arr[i]; if(i>=win) s-=arr[i-win]; if(i>=win-1) out.push(s/win);} return out; }

// Gauge SVG (0..100)
function gaugeSVG(value){
  const v = Math.max(0, Math.min(100, Number(value)||0));
  const angle = -90 + (v/100)*180; // -90° → +90°
  const segs = [
    {a:-90,b:-54,c:"#ff4d4d"},
    {a:-54,b:-18,c:"#ffb84d"},
    {a:-18,b:18,c:"#cccc66"},
    {a:18,b:54,c:"#88cc66"},
    {a:54,b:90,c:"#33aa55"}
  ];
  const arc=(a,b)=>{const r=70,cx=100,cy=100,ra=a*Math.PI/180,rb=b*Math.PI/180,
    x1=cx+r*Math.cos(ra),y1=cy+r*Math.sin(ra),x2=cx+r*Math.cos(rb),y2=cy+r*Math.sin(rb);
    return `M ${x1} ${y1} A ${r} ${r} 0 0 1 ${x2} ${y2}`;};
  const nx=100+60*Math.cos(angle*Math.PI/180), ny=100+60*Math.sin(angle*Math.PI/180);
  return `<svg viewBox="0 0 200 130" class="gauge">
    <g>${segs.map(s=>`<path d="${arc(s.a,s.b)}" stroke="${s.c}" stroke-width="12" fill="none"/>`).join("")}</g>
    <line x1="100" y1="100" x2="${nx.toFixed(1)}" y2="${ny.toFixed(1)}" stroke="var(--text)" stroke-width="3"/>
    <circle cx="100" cy="100" r="5" fill="var(--text)"/>
    <text x="100" y="120" text-anchor="middle" font-size="14" fill="var(--text)" font-family="Arial">${Math.round(v)}</text>
  </svg>`;
}

// Simple price chart (canvas)
function drawPriceChart(canvas, series){
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  if(!series.length) return;
  const xs = series.map(p=>p.t), ys = series.map(p=>p.v);
  const x0 = xs[0], x1 = xs[xs.length-1];
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const padL=50, padR=10, padT=10, padB=24;
  const x = t => padL + ((t-x0)/(x1-x0))*(W-padL-padR);
  const y = v => H-padB - ((v-minY)/(maxY-minY))*(H-padT-padB);

  // grid
  const g=5; ctx.strokeStyle="rgba(128,128,128,.25)"; ctx.lineWidth=1;
  for(let i=0;i<=g;i++){ const gy=padT+i*(H-padT-padB)/g; ctx.beginPath(); ctx.moveTo(padL,gy); ctx.lineTo(W-padR,gy); ctx.stroke(); }
  // line
  ctx.strokeStyle="var(--accent)"; ctx.lineWidth=1.6; ctx.beginPath();
  series.forEach((p,i)=>{ const px=x(p.t), py=y(p.v); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); });
  ctx.stroke();
  // labels
  ctx.fillStyle="var(--text-secondary)"; ctx.font="12px Arial";
  ctx.fillText("$"+fmt(maxY.toFixed(0)), 6, y(maxY)+4);
  ctx.fillText("$"+fmt(minY.toFixed(0)), 6, y(minY)+12);
}

function card(title, html, tone="", tip=""){
  const cls = tone==="bull"?"ok":tone==="warn"?"warn":tone==="bear"?"bad":"";
  const tipAttr = tip ? ` data-tip="${tip.replace(/"/g,'&quot;')}"` : "";
  return `<div class="card ${cls}"${tipAttr}><h3>${title}</h3>${html}</div>`;
}

function scoreLabel(x){
  if (x>=2.5) return `Bullish (${x.toFixed(1)})`;
  if (x<=-2.5) return `Bearish (${x.toFixed(1)})`;
  return `Neutral (${x.toFixed(1)})`;
}

async function main(){
  $("#grid").innerHTML = "";
  $("#refreshBtn").disabled = true;
  $("#asof").textContent = "Updating…";
  $("#asofChart").textContent = "Updating…";

  let score=0;
  const cards=[];

  // ---- Fetch core + chart ----
  let priceUSD=null, dominance=null, totalM=null, altM=null, vol24=null, supply=null, chartCaps=null;

  try{
    const [g, p, coin, chart] = await Promise.all([
      getJSON(CG_GLOBAL),
      getJSON(CG_PRICE),
      getJSON(CG_COIN),
      getJSON(CG_MKTCHART)
    ]);

    // Chart (prices)
    const s = (chart.prices||[]).map(([t,v])=>({t:Math.floor(t/1000), v}));
    drawPriceChart($("#priceChart"), s);
    $("#asofChart").textContent = "Last: " + new Date(s[s.length-1].t*1000).toLocaleDateString();

    // Core
    priceUSD = p.bitcoin.usd;
    const btcCap = coin.market_data.market_cap.usd;
    dominance = g.data.market_cap_percentage.btc;
    totalM    = g.data.total_market_cap.usd;
    vol24     = g.data.total_volume.usd;
    supply    = coin.market_data.circulating_supply || (btcCap && priceUSD ? btcCap/priceUSD : null);
    altM      = Math.max(0, totalM - btcCap);
    chartCaps = chart.market_caps || []; // [[t, cap], ...]

    const liqRatio = (totalM>0) ? vol24/totalM : null;

    // منفصلة لكل بطاقة
    cards.push(card("BTC Price (CoinGecko)", `<div class="center big">$${fmt(priceUSD.toFixed(0))}</div>`,
      "", "Spot price in USD (CoinGecko simple/price)."));

    cards.push(card("BTC Dominance", `<div class="center big">${dominance.toFixed(1)}%</div>`,
      dominance>=55?"bull":dominance<=45?"warn":"", "BTC share of total crypto market cap."));

    cards.push(card("Total Market Cap", `<div class="center big">$${fmt(totalM.toFixed(0))}</div>`,
      "", "Total crypto market capitalization (USD)."));

    cards.push(card("Altcoin Market Cap", `<div class="center big">$${fmt(altM.toFixed(0))}</div>`,
      "", "Total market cap minus BTC market cap."));

    cards.push(card("24h Total Volume", `<div class="center big">$${fmt(vol24.toFixed(0))}</div>`,
      "", "Total traded volume in last 24h across tracked markets."));

    cards.push(card("Volume / Market Cap", `<div class="center big">${liqRatio!=null?(liqRatio*100).toFixed(2)+"%":"—"}</div>`,
      "", "Liquidity ratio = 24h Volume ÷ Total Market Cap."));

    // Score tweak
    if (dominance >= 55) score += 0.4; else if (dominance <= 45) score -= 0.2;

    // S2F approx
    const flowYear = 3.125 * 144 * 365; // subsidy × blocks/day × 365
    const s2f = supply ? (supply/flowYear) : null;
    let s2fTone="", s2fMsg="Informational only";
    if(s2f!=null && s2f>100){ s2fTone="bull"; s2fMsg="High scarcity"; score+=0.2; }
    cards.push(card("Stock-to-Flow (approx)", `
      <div class="kv"><span>Stock (circulating)</span><span>${supply?fmt(supply.toFixed(0)):"—"} BTC</span></div>
      <div class="kv"><span>Flow / year (est.)</span><span>${fmt(flowYear.toFixed(0))} BTC</span></div>
      <div class="kv"><span>S2F</span><span class="big">${s2f? s2f.toFixed(1):"—"}</span></div>
      <div class="muted">${s2fMsg}</div>
    `, s2fTone, "Approximation using current subsidy × blocks/day × 365."));

  }catch(e){
    console.error("BTC Core data error:", e);
    cards.push(card("Core Data", `<div class="muted">Error: ${e.message}</div>`));
  }

  // Fear & Greed (Gauge)
  try{
    const f = await getJSON(FNG);
    const now = f?.data?.[0];
    if(now){
      const v = Number(now.value);
      let tone="", msg="Neutral";
      if(v<=25){ tone="bear"; msg="Extreme fear"; score -= .8; }
      else if(v<=45){ tone="warn"; msg="Fear"; score -= .4; }
      else if(v>=75){ tone="warn"; msg="Extreme greed"; score -= .4; }
      else if(v>=55){ tone="bull"; msg="Greed"; score += .2; }
      cards.push(card("Fear & Greed (Gauge)",
        `<div class="center">${gaugeSVG(v)}</div>
         <div class="center muted">${now.value_classification} — ${new Date(Number(now.timestamp)*1000).toLocaleDateString()}</div>`,
        tone, "Sentiment index (0=extreme fear, 100=extreme greed)."));
    }
  }catch(e){
    cards.push(card("Fear & Greed", `<div class="muted">Error: ${e.message}</div>`));
  }

  // Hashrate
  try{
    const h = await getJSON(BCH_HASH);
    const pts=h?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="—"; if(ch!=null){ if(ch>.05){tone="bull";msg="Rising";score+=.3;} else if(ch<-.05){tone="warn";msg="Falling";score-=.2;} }
    cards.push(card("Hashrate (Blockchain.com)",
      `<div class="kv"><span>Latest</span><span class="big">${latest?fmt(latest.toFixed(2)):"—"} EH/s</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Estimated network hash rate (exahashes/second)."));
  }catch(e){ cards.push(card("Hashrate", `<div class="muted">Error: ${e.message}</div>`)); }

  // Difficulty
  try{
    const d = await getJSON(BCH_DIFF);
    const pts=d?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="—"; if(ch!=null){ if(ch>.03){tone="bull";msg="Trending up";score+=.2;} else if(ch<-.03){tone="warn";msg="Trending down";score-=.1;} }
    cards.push(card("Mining Difficulty",
      `<div class="kv"><span>Latest</span><span class="big">${latest?fmt(latest.toFixed(0)):"—"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Protocol setting controlling how hard it is to mine a block."));
  }catch(e){ cards.push(card("Mining Difficulty", `<div class="muted">Error: ${e.message}</div>`)); }

  // Active Addresses
  try{
    const a = await getJSON(BCH_ADDR);
    const pts=a?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="—"; if(ch!=null){ if(ch>.05){tone="bull";msg="Activity up";score+=.3;} else if(ch<-.05){tone="warn";msg="Activity down";score-=.2;} }
    cards.push(card("Active Addresses",
      `<div class="kv"><span>Latest</span><span class="big">${latest?fmt(latest.toFixed(0)):"—"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Daily count of unique addresses active on-chain."));
  }catch(e){ cards.push(card("Active Addresses", `<div class="muted">Error: ${e.message}</div>`)); }

  // Fees (daily) + fallback إلى mempool
  try{
    const f = await getJSON(BCH_FEES_USD);
    const pts=f?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const feesUSD=last?.y||null; const ch=(feesUSD&&prev)?(feesUSD-prev.y)/prev.y:null;
    let tone="", msg="—"; 
    if(ch!=null){ if(ch>.25){tone="warn";msg="Congestion";score-=.2;} else if(ch<-.25){tone="bull";msg="Low fees";score+=.1;} }
    cards.push(card("Daily Fees (Blockchain.com)",
      `<div class="kv"><span>Latest</span><span class="big">${feesUSD?"$"+fmt(feesUSD.toFixed(0)):"—"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Total daily transaction fees in USD."));
  }catch(e){ 
    try{
      const mempoolFees = await getJSON(MEMPOOL_FEES);
      cards.push(card("Current Fees (Mempool.space)",
        `<div class="kv"><span>Fast</span><span class="big">${mempoolFees.fastestFee} sat/vB</span></div>
         <div class="kv"><span>Standard</span><span>${mempoolFees.halfHourFee} sat/vB</span></div>
         <div class="kv"><span>Economy</span><span>${mempoolFees.hourFee} sat/vB</span></div>`,
        "", "Current recommended transaction fees."));
    }catch(e2){
      cards.push(card("Daily Fees", `<div class="muted">Error: ${e.message}</div>`));
    }
  }

  // Transaction Volume (USD)
  try{
    const t = await getJSON(BCH_TXV_USD);
    const pts=t?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="—"; if(ch!=null){ if(ch>.05){tone="bull";msg="Volume up";score+=.2;} else if(ch<-.05){tone="warn";msg="Volume down";score-=.1;} }
    cards.push(card("Transaction Volume (USD)",
      `<div class="kv"><span>Latest</span><span class="big">${latest?"$"+fmt(latest.toFixed(0)):"—"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Estimated daily value of on-chain transactions in USD."));
  }catch(e){ cards.push(card("Transaction Volume", `<div class="muted">Error: ${e.message}</div>`)); }

  // ===== NVT + Golden Cross (approx, مجاني) =====
  try{
    // نستخدم market_caps من نفس استدعاء CoinGecko السابق (chartCaps) + Tx Volume USD
    const txvSeries = (await getJSON(BCH_TXV_USD)).values || []; // {x:ts, y:usd}
    const mc = (chartCaps||[]).map(([t,v])=>({t:Math.floor(t/1000), v}));

    // دمج السلاسل بحسب التاريخ (تسامح يوم ونصف)
    function joinSeries(a,b){
      const out=[]; let j=0;
      for(let i=0;i<a.length;i++){
        const ta=a[i].t;
        while(j<b.length-1 && b[j+1].x<=ta*1000) j++;
        const tb = b[j]?.x ? Math.floor(b[j].x/1000) : null;
        if(tb && Math.abs(tb-ta)<=86400*1.5){
          out.push({t:ta, a:a[i].v, b:b[j].y});
        }
      }
      return out;
    }

    const joined = joinSeries(mc, txvSeries).filter(x=>x.a>0 && x.b>0);
    if(joined.length){
      const nvtArr = joined.map(x=>x.a/x.b);
      const latest = nvtArr[nvtArr.length-1];

      let tone="", msg="Neutral zone";
      if(latest<20){ tone="bull"; msg="Strong buying opportunity"; score+=.6; }
      else if(latest<40){ tone="bull"; msg="Fair value / potential buy"; score+=.2; }
      else if(latest>=70 && latest<80){ tone="warn"; msg="Potential overvaluation"; score-=.2; }
      else if(latest>=80){ tone="bear"; msg="Bubble risk"; score-=.6; }

      const ma10=SMA(nvtArr,10), ma30=SMA(nvtArr,30);
      let gcTxt="—", gcTone="";
      if(ma30.length){
        const gc=(ma10[ma10.length-1]-ma30[ma30.length-1])/ma30[ma30.length-1];
        gcTxt=(gc*100).toFixed(2)+"%";
        if(gc<-1.5){gcTone="bull";}
        else if(gc>2.1){gcTone="bear";}
      }

      cards.push(card("NVT (Network Value to Tx)",
        `<div class="center big">${latest.toFixed(1)}</div>
         <div class="center muted">${msg}</div>`,
        tone, "Market cap ÷ daily on-chain transaction value (USD). Lower = cheaper."));

      cards.push(card("NVT Golden Cross (approx)",
        `<div class="center big">${gcTxt}</div>
         <div class="center muted">Negative = undervalued, Positive = overvalued</div>`,
        gcTone, "MA crossover of NVT (10 vs 30) to reduce noise."));
    }
  }catch(e){
    cards.push(card("NVT / Golden Cross", `<div class="muted">Error: ${e.message}</div>`));
  }

  // Placeholder لمؤشر MVRV (غير متاح مجانًا)
  cards.push(card("MVRV Ratio",
    `<div class="muted">Free public API not available. Add Glassnode/CryptoQuant later when you have an API/proxy.</div>`,
    "", "Market Value ÷ Realized Value. <1 undervalued, >3.5 overvalued (heuristic)."));

  // Final score
  $("#marketScore").textContent = "Market Score: " + scoreLabel(score);
  $("#grid").innerHTML = cards.join("");
  $("#asof").textContent = "Last updated: " + new Date().toLocaleString();
  $("#refreshBtn").disabled = false;
}

// Toggle chart
$("#toggleChartBtn").addEventListener("click", ()=>{
  const chartBox = $("#chartBox");
  if(chartBox.style.display === "none"){
    chartBox.style.display = "block";
    $("#toggleChartBtn").textContent = "Hide chart";
  }else{
    chartBox.style.display = "none";
    $("#toggleChartBtn").textContent = "Show chart";
  }
});

// Refresh button
$("#refreshBtn").addEventListener("click", main);

// Initial load
main();
</script>
</body>
</html>
