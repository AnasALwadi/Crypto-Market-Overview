<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BTC/USDT â€” Market Overview (Free Data)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  
  :root{
    --bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
    --surface: rgba(23, 26, 33, 0.8);
    --surface-hover: rgba(30, 35, 45, 0.9);
    --border: rgba(56, 68, 77, 0.3);
    --border-hover: rgba(56, 68, 77, 0.6);
    --text: #e6e8eb;
    --text-secondary: #9aa0a6;
    --ok: #10b981;
    --warn: #f59e0b;
    --bad: #ef4444;
    --accent: #3b82f6;
    --accent-secondary: #8b5cf6;
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --card-shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.4);
    --glow: 0 0 20px rgba(59, 130, 246, 0.3);
  }
  
  /* Light theme vars */
  @media (prefers-color-scheme: light){
    :root{ 
      --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --surface: rgba(255, 255, 255, 0.9);
      --surface-hover: rgba(248, 250, 252, 1);
      --border: rgba(226, 232, 240, 0.8);
      --border-hover: rgba(148, 163, 184, 0.6);
      --text: #1e293b;
      --text-secondary: #64748b;
      --card-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
      --card-shadow-hover: 0 12px 48px rgba(15, 23, 42, 0.12);
      --glow: 0 0 20px rgba(59, 130, 246, 0.2);
    }
  }
  
  /* Force theme via attribute */
  html[data-theme="light"]{
    --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    --surface: rgba(255, 255, 255, 0.9);
    --surface-hover: rgba(248, 250, 252, 1);
    --border: rgba(226, 232, 240, 0.8);
    --border-hover: rgba(148, 163, 184, 0.6);
    --text: #1e293b;
    --text-secondary: #64748b;
    --card-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
    --card-shadow-hover: 0 12px 48px rgba(15, 23, 42, 0.12);
    --glow: 0 0 20px rgba(59, 130, 246, 0.2);
  }
  
  html[data-theme="dark"]{
    --bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
    --surface: rgba(23, 26, 33, 0.8);
    --surface-hover: rgba(30, 35, 45, 0.9);
    --border: rgba(56, 68, 77, 0.3);
    --border-hover: rgba(56, 68, 77, 0.6);
    --text: #e6e8eb;
    --text-secondary: #9aa0a6;
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --card-shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.4);
    --glow: 0 0 20px rgba(59, 130, 246, 0.3);
  }

  /* Base */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-weight: 400;
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
  }
  
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
      radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
  }
  
  .wrap {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px 20px;
    position: relative;
  }
  
  .brand {
    display: flex;
    gap: 16px;
    justify-content: space-between;
    align-items: center;
    margin: 0 0 32px;
    padding: 24px 0;
    border-bottom: 1px solid var(--border);
  }
  
  .brand h1 {
    margin: 0;
    font-size: clamp(24px, 4vw, 32px);
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .me {
    color: var(--warn);
    font-weight: 600;
    font-size: 14px;
    padding: 8px 16px;
    background: rgba(245, 158, 11, 0.1);
    border-radius: 20px;
    border: 1px solid rgba(245, 158, 11, 0.2);
  }
  
  .btn {
    background: var(--surface);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 12px;
    padding: 10px 16px;
    cursor: pointer;
    box-shadow: var(--card-shadow);
    font-family: inherit;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  
  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.5s;
  }
  
  .btn:hover::before {
    left: 100%;
  }
  
  .btn:hover {
    background: var(--surface-hover);
    border-color: var(--border-hover);
    box-shadow: var(--card-shadow-hover);
    transform: translateY(-2px);
  }
  
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  
  .pill {
    padding: 10px 20px;
    border: 1px solid var(--border);
    border-radius: 25px;
    background: var(--surface);
    backdrop-filter: blur(10px);
    font-weight: 600;
    font-size: 14px;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
  }
  
  .pill:hover {
    box-shadow: var(--glow);
    transform: translateY(-1px);
  }
  
  .muted {
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
  }
  
  .grid {
    display: grid;
    gap: 24px;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    align-items: stretch;
    margin-bottom: 32px;
  }
  
  .card {
    background: var(--surface);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-shadow: var(--card-shadow);
    position: relative;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
  }
  
  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .card:hover::before {
    opacity: 1;
  }
  
  .card:hover {
    background: var(--surface-hover);
    border-color: var(--border-hover);
    box-shadow: var(--card-shadow-hover);
    transform: translateY(-4px) scale(1.02);
  }
  
  .card h3 {
    margin: 0 0 16px;
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.025em;
  }
  
  .kv {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    margin: 10px 0;
    align-items: center;
  }
  
  .kv span:first-child {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
  }
  
  .kv span:last-child {
    font-weight: 600;
    color: var(--text);
  }
  
  .big {
    font-size: clamp(20px, 3vw, 28px);
    font-weight: 800;
    letter-spacing: -0.025em;
    background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .center {
    text-align: center;
  }
  
  .ok {
    border-color: var(--ok);
    background: rgba(16, 185, 129, 0.05);
  }
  
  .ok::before {
    background: linear-gradient(90deg, var(--ok), #34d399);
  }
  
  .warn {
    border-color: var(--warn);
    background: rgba(245, 158, 11, 0.05);
  }
  
  .warn::before {
    background: linear-gradient(90deg, var(--warn), #fbbf24);
  }
  
  .bad {
    border-color: var(--bad);
    background: rgba(239, 68, 68, 0.05);
  }
  
  .bad::before {
    background: linear-gradient(90deg, var(--bad), #f87171);
  }

  /* Tooltip on cards */
  .card[data-tip]::after {
    content: attr(data-tip);
    position: absolute;
    left: 16px;
    right: 16px;
    bottom: 16px;
    background: rgba(0, 0, 0, 0.9);
    color: #fff;
    font-size: 12px;
    line-height: 1.4;
    padding: 12px 16px;
    border-radius: 12px;
    opacity: 0;
    transform: translateY(8px);
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    z-index: 10;
  }
  
  html[data-theme="light"] .card[data-tip]::after {
    background: rgba(30, 34, 44, 0.95);
  }
  
  .card:hover::after {
    opacity: 1;
    transform: translateY(0);
  }

  /* Chart box */
  .chartWrap {
    background: var(--surface);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    margin: 0 0 32px;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .chartWrap::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
  }
  
  .chartWrap:hover {
    box-shadow: var(--card-shadow-hover);
    transform: translateY(-2px);
  }
  
  canvas#priceChart {
    width: 100%;
    height: 400px;
    display: block;
    border-radius: 12px;
  }
  
  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  
  .toolbar .muted {
    font-weight: 600;
  }
  
  .gauge {
    width: 100%;
    max-width: 280px;
    margin: auto;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
  }
  
  /* Responsive design */
  @media (max-width: 768px) {
    .wrap {
      padding: 16px 12px;
    }
    
    .brand {
      flex-direction: column;
      gap: 16px;
      text-align: center;
    }
    
    .row {
      justify-content: center;
    }
    
    .grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .card {
      padding: 20px;
      min-height: 180px;
    }
    
    canvas#priceChart {
      height: 300px;
    }
  }
  
  @media (max-width: 480px) {
    .brand h1 {
      font-size: 24px;
    }
    
    .btn, .pill {
      font-size: 13px;
      padding: 8px 12px;
    }
    
    .card {
      padding: 16px;
      border-radius: 16px;
    }
    
    .chartWrap {
      padding: 16px;
      border-radius: 16px;
    }
  }
  
  /* Loading animation */
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .loading {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }
  
  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  
  ::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: var(--border-hover);
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <h1>BTC/USDT â€” Market Overview</h1>
    <div class="row">
      <div class="pill" id="marketScore">Market Score: loadingâ€¦</div>
      <button class="btn" id="toggleChartBtn">Hide chart</button>
      <button class="btn" id="refreshBtn">Refresh</button>
      <button class="btn" id="themeBtn" title="Toggle theme">Theme: Auto</button>
      <div class="me">Made by Anas Alwadi</div>
    </div>
  </div>

  <!-- Chart -->
  <div class="chartWrap" id="chartBox">
    <div class="toolbar">
      <div class="muted">BTC/USDT â€” last 180 days</div>
      <div class="muted" id="asofChart">Updatingâ€¦</div>
    </div>
    <canvas id="priceChart" width="1080" height="340" aria-label="BTC price"></canvas>
  </div>

  <!-- Cards -->
  <div class="grid" id="grid"></div>
  <p class="muted" id="asof" style="margin-top:10px"></p>
</div>

<script>
const $ = s => document.querySelector(s);
const fmt = n => Number(n).toLocaleString();
const pct = x => (x==null||!isFinite(x)) ? "â€”" : (x*100).toFixed(2)+"%";
const bust = url => url + (url.includes("?")?"&":"?") + "t=" + Date.now();

// Theme toggle: auto / light / dark
function applyTheme(mode){
  const html = document.documentElement;
  if(mode==="auto"){ html.setAttribute("data-theme","auto"); }
  else if(mode==="light"){ html.setAttribute("data-theme","light"); }
  else { html.setAttribute("data-theme","dark"); }
  localStorage.setItem("themeMode", mode);
  $("#themeBtn").textContent = "Theme: " + mode[0].toUpperCase()+mode.slice(1);
}
(function initTheme(){
  applyTheme(localStorage.getItem("themeMode") || "auto");
})();
$("#themeBtn").addEventListener("click", ()=>{
  const order=["auto","light","dark"];
  const cur = localStorage.getItem("themeMode") || "auto";
  const next = order[(order.indexOf(cur)+1)%order.length];
  applyTheme(next);
});

// Data sources
const CG_PRICE    = "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd";
const CG_GLOBAL   = "https://api.coingecko.com/api/v3/global";
const CG_COIN     = "https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false";
const CG_MKTCHART = "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=180&interval=daily";
const FNG         = "https://api.alternative.me/fng/?limit=2";
const BCH_HASH    = "https://api.blockchain.info/charts/hash-rate?timespan=60days&format=json&cors=true";
const BCH_DIFF    = "https://api.blockchain.info/charts/difficulty?timespan=60days&format=json&cors=true";
const BCH_ADDR    = "https://api.blockchain.info/charts/n-unique-addresses?timespan=60days&format=json&cors=true";
const BCH_TXV_USD = "https://api.blockchain.info/charts/estimated-transaction-volume-usd?timespan=180days&format=json&cors=true";
const BCH_FEES_USD= "https://api.blockchain.info/charts/transaction-fees-usd?timespan=60days&format=json&cors=true";
const BCH_MVRV    = "https://api.blockchain.info/charts/mvrv?timespan=60days&format=json&cors=true";
const BCH_NVT     = "https://api.blockchain.info/charts/nvt?timespan=60days&format=json&cors=true";
const BCH_UTXO    = "https://api.blockchain.info/charts/utxo-count?timespan=60days&format=json&cors=true";
const MEMPOOL_FEES = "https://mempool.space/api/v1/fees/recommended";
const MEMPOOL_STATS = "https://mempool.space/api/mempool";

async function getJSON(url){
  const r = await fetch(bust(url), {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
function SMA(arr, win){ const out=[]; let s=0; for(let i=0;i<arr.length;i++){ s+=arr[i]; if(i>=win) s-=arr[i-win]; if(i>=win-1) out.push(s/win);} return out; }

// Gauge SVG (0..100)
function gaugeSVG(value){
  const v = Math.max(0, Math.min(100, Number(value)||0));
  const angle = (v/100)*180; // 0 to 180 degrees
  const segs = [
    {a:0,b:36,c:"#ff4d4d"},{a:36,b:72,c:"#ffb84d"},{a:72,b:108,c:"#cccc66"},{a:108,b:144,c:"#88cc66"},{a:144,b:180,c:"#33aa55"}
  ];
  const arc=(a,b)=>{const r=70,cx=100,cy=100,ra=a*Math.PI/180,rb=b*Math.PI/180,x1=cx+r*Math.cos(ra),y1=cy+r*Math.sin(ra),x2=cx+r*Math.cos(rb),y2=cy+r*Math.sin(rb);return `M ${x1} ${y1} A ${r} ${r} 0 0 1 ${x2} ${y2}`;};
  const nx=100+60*Math.cos(angle*Math.PI/180), ny=100+60*Math.sin(angle*Math.PI/180);
  return `<svg viewBox="0 0 200 130" class="gauge" style="transform: rotateX(180deg) rotateY(180deg);">
  <g>${segs.map(s=>`<path d="${arc(s.a,s.b)}" stroke="${s.c}" stroke-width="12" fill="none"/>`).join("")}</g>
  <line x1="100" y1="100" x2="${nx.toFixed(1)}" y2="${ny.toFixed(1)}" stroke="var(--text)" stroke-width="3"/><circle cx="100" cy="100" r="5" fill="var(--text)"/>
  <text x="100" y="120" text-anchor="middle" font-size="14" fill="var(--text)" font-family="Arial">${Math.round(v)}</text></svg>`;
}

// Simple price chart (canvas)
function drawPriceChart(canvas, series){
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  if(!series.length) return;
  const xs = series.map(p=>p.t), ys = series.map(p=>p.v);
  const x0 = xs[0], x1 = xs[xs.length-1];
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const padL=50, padR=10, padT=10, padB=24;
  const x = t => padL + ((t-x0)/(x1-x0))*(W-padL-padR);
  const y = v => H-padB - ((v-minY)/(maxY-minY))*(H-padT-padB);

  // grid
  const g=5; ctx.strokeStyle="rgba(128,128,128,.25)"; ctx.lineWidth=1;
  for(let i=0;i<=g;i++){ const gy=padT+i*(H-padT-padB)/g; ctx.beginPath(); ctx.moveTo(padL,gy); ctx.lineTo(W-padR,gy); ctx.stroke(); }
  // line
  ctx.strokeStyle="var(--accent)"; ctx.lineWidth=1.6; ctx.beginPath();
  series.forEach((p,i)=>{ const px=x(p.t), py=y(p.v); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); });
  ctx.stroke();
  // axis labels
  ctx.fillStyle="var(--muted)"; ctx.font="12px Arial";
  ctx.fillText("$"+fmt(maxY.toFixed(0)), 6, y(maxY)+4);
  ctx.fillText("$"+fmt(minY.toFixed(0)), 6, y(minY)+12);
}

function card(title, html, tone="", tip=""){
  const cls = tone==="bull"?"ok":tone==="warn"?"warn":tone==="bear"?"bad":"";
  const tipAttr = tip ? ` data-tip="${tip.replace(/"/g,'&quot;')}"` : "";
  return `<div class="card ${cls}"${tipAttr}><h3>${title}</h3>${html}</div>`;
}

function scoreLabel(x){
  if (x>=2.5) return `Bullish (${x.toFixed(1)})`;
  if (x<=-2.5) return `Bearish (${x.toFixed(1)})`;
  return `Neutral (${x.toFixed(1)})`;
}

async function main(){
  $("#grid").innerHTML = "";
  $("#refreshBtn").disabled = true;
  $("#asof").textContent = "Updatingâ€¦";
  $("#asofChart").textContent = "Updatingâ€¦";

  let score=0;
  const cards=[];

  // ---- Fetch core + chart ----
  let priceUSD=null, dominance=null, totalM=null, altM=null, vol24=null, supply=null;

  try{
    const [g, p, coin, chart] = await Promise.all([
      getJSON(CG_GLOBAL),
      getJSON(CG_PRICE),
      getJSON(CG_COIN),
      getJSON(CG_MKTCHART)
    ]);

    // Chart
    const s = (chart.prices||[]).map(([t,v])=>({t:Math.floor(t/1000), v}));
    drawPriceChart($("#priceChart"), s);
    $("#asofChart").textContent = "Last: " + new Date(s[s.length-1].t*1000).toLocaleDateString();

    // Core
    priceUSD = p.bitcoin.usd;
    const btcCap = coin.market_data.market_cap.usd;
    dominance = g.data.market_cap_percentage.btc;
    totalM    = g.data.total_market_cap.usd;
    vol24     = g.data.total_volume.usd;
    supply    = coin.market_data.circulating_supply || (btcCap && priceUSD ? btcCap/priceUSD : null);
    altM      = Math.max(0, totalM - btcCap);
    const liqRatio = (totalM>0) ? vol24/totalM : null;

    // Separate BTC cards (each alone)
    cards.push(card("BTC Price (CoinGecko)", `<div class="center big">$${fmt(priceUSD.toFixed(0))}</div>`,
      "", "Spot price in USD (CoinGecko simple/price)."));
    cards.push(card("BTC Dominance", `<div class="center big">${dominance.toFixed(1)}%</div>`,
      dominance>=55?"bull":dominance<=45?"warn":"", "BTC market cap share in the total crypto market."));
    cards.push(card("Total Market Cap", `<div class="center big">$${fmt(totalM.toFixed(0))}</div>`,
      "", "Total crypto market capitalization (USD)."));
    cards.push(card("Altcoin Market Cap", `<div class="center big">$${fmt(altM.toFixed(0))}</div>`,
      "", "Total market cap minus BTC market cap."));
    cards.push(card("24h Total Volume", `<div class="center big">$${fmt(vol24.toFixed(0))}</div>`,
      "", "Total traded volume in the last 24h across tracked markets."));
    cards.push(card("Volume / Market Cap", `<div class="center big">${liqRatio!=null?(liqRatio*100).toFixed(2)+"%":"â€”"}</div>`,
      "", "Liquidity ratio = 24h Volume Ã· Total Market Cap."));
    // Score tweak
    if (dominance >= 55) score += 0.4; else if (dominance <= 45) score -= 0.2;

    // S2F approx
    const flowYear = 3.125 * 144 * 365;
    const s2f = supply ? (supply/flowYear) : null;
    let s2fTone="", s2fMsg="Informational only";
    if(s2f!=null && s2f>100){ s2fTone="bull"; s2fMsg="High scarcity"; score+=0.2; }
    cards.push(card("Stock-to-Flow (approx)", `
      <div class="kv"><span>Stock (circulating)</span><span>${supply?fmt(supply.toFixed(0)):"â€”"} BTC</span></div>
      <div class="kv"><span>Flow / year (est.)</span><span>${fmt(flowYear.toFixed(0))} BTC</span></div>
      <div class="kv"><span>S2F</span><span class="big">${s2f? s2f.toFixed(1):"â€”"}</span></div>
      <div class="muted">${s2fMsg}</div>
    `, s2fTone, "Approximation: uses current block subsidy Ã— blocks/day Ã— 365."));

  }catch(e){
    console.error("BTC Core data error:", e);
    // Add individual cards with error messages for better debugging
    cards.push(card("BTC Price", `<div class="muted">Error loading price data</div>`));
    cards.push(card("BTC Dominance", `<div class="muted">Error loading dominance data</div>`));
    cards.push(card("Total Market Cap", `<div class="muted">Error loading market data</div>`));
    cards.push(card("Chart Data", `<div class="muted">Error loading chart: ${e.message}</div>`));
  }

  // Fear & Greed (Gauge)
  try{
    const f = await getJSON(FNG);
    const now = f?.data?.[0];
    if(now){
      const v = Number(now.value);
      let tone="", msg="Neutral";
      if(v<=25){ tone="bear"; msg="Extreme fear"; score -= .8; }
      else if(v<=45){ tone="warn"; msg="Fear"; score -= .4; }
      else if(v>=75){ tone="warn"; msg="Extreme greed"; score -= .4; }
      else if(v>=55){ tone="bull"; msg="Greed"; score += .2; }
      cards.push(card("Fear & Greed (Gauge)",
        `<div class="center">${gaugeSVG(v)}</div>
         <div class="center muted">${now.value_classification} â€” ${new Date(Number(now.timestamp)*1000).toLocaleDateString()}</div>`,
        tone, "Sentiment index (0=extreme fear, 100=extreme greed)."));
    }
  }catch(e){
    cards.push(card("Fear & Greed", `<div class="muted">Error: ${e.message}</div>`));
  }

  // Hashrate
  try{
    const h = await getJSON(BCH_HASH);
    const pts=h?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="â€”"; if(ch!=null){ if(ch>.05){tone="bull";msg="Rising";score+=.3;} else if(ch<-.05){tone="warn";msg="Falling";score-=.2;} }
    cards.push(card("Hashrate (Blockchain.com)",
      `<div class="kv"><span>Latest</span><span class="big">${latest?fmt(latest.toFixed(2)):"â€”"} EH/s</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Estimated network hash rate (exahashes/second)."));
  }catch(e){ cards.push(card("Hashrate", `<div class="muted">Error: ${e.message}</div>`)); }

  // Difficulty
  try{
    const d = await getJSON(BCH_DIFF);
    const pts=d?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="â€”"; if(ch!=null){ if(ch>.03){tone="bull";msg="Trending up";score+=.2;} else if(ch<-.03){tone="warn";msg="Trending down";score-=.1;} }
    cards.push(card("Mining Difficulty",
      `<div class="kv"><span>Latest</span><span class="big">${latest?fmt(latest.toFixed(0)):"â€”"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Protocol setting controlling how hard it is to mine a block."));
  }catch(e){ cards.push(card("Mining Difficulty", `<div class="muted">Error: ${e.message}</div>`)); }

  // Active Addresses
  try{
    const a = await getJSON(BCH_ADDR);
    const pts=a?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="â€”"; if(ch!=null){ if(ch>.05){tone="bull";msg="Activity up";score+=.3;} else if(ch<-.05){tone="warn";msg="Activity down";score-=.2;} }
    cards.push(card("Active Addresses",
      `<div class="kv"><span>Latest</span><span class="big">${latest?fmt(latest.toFixed(0)):"â€”"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Daily count of unique addresses active on-chain."));
  }catch(e){ cards.push(card("Active Addresses", `<div class="muted">Error: ${e.message}</div>`)); }

  // Fees (daily)
  try{
    const f = await getJSON(BCH_FEES_USD);
    const pts=f?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const feesUSD=last?.y||null; const ch=(feesUSD&&prev)?(feesUSD-prev.y)/prev.y:null;
    let tone="", msg="â€”"; if(ch!=null){ if(ch>.25){tone="warn";msg="Congestion";
      score-=.2; } else if(ch<-.25){tone="bull";msg="Low fees";score+=.1;} }
    cards.push(card("Daily Fees (Blockchain.com)",
      `<div class="kv"><span>Latest</span><span class="big">${feesUSD?"$"+fmt(feesUSD.toFixed(0)):"â€”"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Total daily transaction fees in USD."));
  }catch(e){ 
    // Fallback to mempool.space for current fees
    try{
      const mempoolFees = await getJSON(MEMPOOL_FEES);
      cards.push(card("Current Fees (Mempool.space)",
        `<div class="kv"><span>Fast</span><span class="big">${mempoolFees.fastestFee} sat/vB</span></div>
         <div class="kv"><span>Standard</span><span>${mempoolFees.halfHourFee} sat/vB</span></div>
         <div class="kv"><span>Economy</span><span>${mempoolFees.hourFee} sat/vB</span></div>`,
        "", "Current recommended transaction fees."));
    }catch(e2){
      cards.push(card("Daily Fees", `<div class="muted">Error: ${e.message}</div>`));
    }
  }

  // Transaction Volume (USD)
  try{
    const t = await getJSON(BCH_TXV_USD);
    const pts=t?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="â€”"; if(ch!=null){ if(ch>.05){tone="bull";msg="Volume up";score+=.2;} else if(ch<-.05){tone="warn";msg="Volume down";score-=.1;} }
    cards.push(card("Transaction Volume (USD)",
      `<div class="kv"><span>Latest</span><span class="big">${latest?"$"+fmt(latest.toFixed(0)):"â€”"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Estimated daily value of on-chain transactions in USD."));
  }catch(e){ cards.push(card("Transaction Volume", `<div class="muted">Error: ${e.message}</div>`)); }

  // MVRV Ratio
  try{
    const mvrv = await getJSON(BCH_MVRV);
    const pts=mvrv?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="â€”"; 
    if(latest!=null){ 
      if(latest>3.7){tone="warn";msg="Overvalued";score-=.3;} 
      else if(latest<1){tone="bull";msg="Undervalued";score+=.3;}
      else {msg="Fair value";}
    }
    cards.push(card("MVRV Ratio",
      `<div class="kv"><span>Latest</span><span class="big">${latest?latest.toFixed(2):"â€”"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Market Value to Realized Value ratio. Values >3.7 suggest overvaluation."));
  }catch(e){ cards.push(card("MVRV Ratio", `<div class="muted">Error: ${e.message}</div>`)); }

  // NVT Ratio
  try{
    const nvt = await getJSON(BCH_NVT);
    const pts=nvt?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="â€”"; 
    if(latest!=null){ 
      if(latest>150){tone="warn";msg="High valuation";score-=.2;} 
      else if(latest<50){tone="bull";msg="Low valuation";score+=.2;}
      else {msg="Normal range";}
    }
    cards.push(card("NVT Ratio",
      `<div class="kv"><span>Latest</span><span class="big">${latest?latest.toFixed(1):"â€”"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Network Value to Transactions ratio. High values suggest overvaluation."));
  }catch(e){ cards.push(card("NVT Ratio", `<div class="muted">Error: ${e.message}</div>`)); }

  // UTXO Count
  try{
    const utxo = await getJSON(BCH_UTXO);
    const pts=utxo?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="â€”"; if(ch!=null){ if(ch>.02){tone="bull";msg="Growing";score+=.1;} else if(ch<-.02){tone="warn";msg="Declining";score-=.1;} }
    cards.push(card("UTXO Count",
      `<div class="kv"><span>Latest</span><span class="big">${latest?fmt(latest.toFixed(0)):"â€”"}</span></div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Number of unspent transaction outputs. Indicates network usage."));
  }catch(e){ cards.push(card("UTXO Count", `<div class="muted">Error: ${e.message}</div>`)); }

  // Mempool Stats
  try{
    const mempool = await getJSON(MEMPOOL_STATS);
    const count = mempool?.count || 0;
    const vsize = mempool?.vsize || 0;
    const totalFees = mempool?.total_fee || 0;
    let tone="", msg="â€”"; 
    if(count > 50000){tone="warn";msg="Congested";score-=.2;} 
    else if(count < 5000){tone="bull";msg="Clear";score+=.1;}
    else {msg="Normal";}
    cards.push(card("Mempool Status",
      `<div class="kv"><span>Pending TXs</span><span class="big">${fmt(count)}</span></div>
       <div class="kv"><span>Size (vMB)</span><span>${(vsize/1000000).toFixed(1)}</span></div>
       <div class="kv"><span>Total Fees</span><span>${(totalFees/100000000).toFixed(2)} BTC</span></div>
       <div class="muted">${msg}</div>`,
      tone, "Current mempool status showing pending transactions."));
  }catch(e){ cards.push(card("Mempool Status", `<div class="muted">Error: ${e.message}</div>`)); }

  // Final score
  $("#marketScore").textContent = "Market Score: " + scoreLabel(score);
  $("#grid").innerHTML = cards.join("");
  $("#asof").textContent = "Last updated: " + new Date().toLocaleString();
  $("#refreshBtn").disabled = false;
}

// Toggle chart
$("#toggleChartBtn").addEventListener("click", ()=>{
  const chartBox = $("#chartBox");
  if(chartBox.style.display === "none"){
    chartBox.style.display = "block";
    $("#toggleChartBtn").textContent = "Hide chart";
  }else{
    chartBox.style.display = "none";
    $("#toggleChartBtn").textContent = "Show chart";
  }
});

// Refresh button
$("#refreshBtn").addEventListener("click", main);

// Initial load
main();
</script>
</body>
</html>
