<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BTC/USDT — Market Overview (Free Data)</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;background:#0f1115;color:#e6e6e6;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:1160px;margin:18px auto;padding:0 14px}
  .brand{display:flex;justify-content:space-between;align-items:center;margin:10px 0 14px}
  .brand h1{margin:0;font-size:18px;color:#ddd}
  .brand .by{font-weight:700;color:#ffd66b}
  .score{background:#171a21;border:1px solid #262b36;border-radius:10px;padding:10px;margin-bottom:12px;display:flex;justify-content:space-between}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .card{background:#171a21;border:1px solid #262b36;border-radius:10px;padding:14px}
  .title{font-weight:700;margin-bottom:8px}
  .kv{display:flex;justify-content:space-between;font-size:14px;margin:6px 0}
  .muted{color:#9aa0a6;font-size:13px}
  .bull{border-color:#2d8a49;background:#142218}
  .bear{border-color:#a94a4a;background:#201517}
  .warn{border-color:#a9842d;background:#241e0f}
  .neu{border-color:#262b36;background:#171a21}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <h1>BTC/USDT — Market Overview</h1>
    <div class="by">Made by Anas Alwadi</div>
  </div>

  <div class="score">
    <div><b>BTC Price:</b> <span id="price">—</span></div>
    <div><b>Market Score:</b> <span id="marketScore">—</span></div>
  </div>

  <div id="grid" class="grid"></div>
</div>

<script>
const $ = s => document.querySelector(s);
const fmt = x => Number(x).toLocaleString();
function card(title, html, tone="neu"){
  return `<div class="card ${tone}">
    <div class="title">${title}</div>
    ${html}
  </div>`;
}
function scoreLabel(s){
  if(s>=1.5) return "Bullish";
  if(s>=0.5) return "Slightly Bullish";
  if(s<=-1.5) return "Bearish";
  if(s<=-0.5) return "Slightly Bearish";
  return "Neutral";
}

// استدعاء وظيفة Netlify (scraper) لسحب SOPR/MVRV
async function getCQ(metric){
  const r = await fetch(`/.netlify/functions/cq_scrape?metric=${metric}`, { cache: "no-store" });
  const j = await r.json();
  if(!r.ok) throw new Error(j.error || "scrape failed");
  return j; // { latest:{t,v}, ... }
}

async function main(){
  const cards = [];
  let score = 0;

  // 1) BTC Price (CoinGecko)
  const p = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd", { cache: "no-store" });
  const pj = await p.json();
  const price = pj?.bitcoin?.usd ?? null;
  if(price) $("#price").textContent = "$" + fmt(price);

  // 2) Stock-to-Flow (approx)
  // NOTE: تقدير تقريبي (معلومة فقط)
  const supplyRes = await fetch("https://api.blockchain.info/q/totalbc?cors=true");
  const totalSatoshis = Number(await supplyRes.text()); // satoshis
  const supplyBTC = totalSatoshis / 1e8;
  const flowYear = 3.125 * 144 * 365; // subsidy * blocks/day * 365 (تقريب بعد Halving 2024)
  const s2f = supplyBTC / flowYear;
  let s2fTone="neu", s2fMsg="Informational only";
  if(s2f>100){ s2fTone="bull"; s2fMsg="High scarcity"; score+=0.2; }
  cards.push(card("Stock-to-Flow (approx)", `
    <div class="kv"><span>Stock (circulating)</span><span>${fmt(supplyBTC.toFixed(0))} BTC</span></div>
    <div class="kv"><span>Flow/yr (est.)</span><span>${fmt(flowYear.toFixed(0))} BTC</span></div>
    <div class="kv"><span>S2F</span><span>${s2f.toFixed(1)}</span></div>
    <div class="muted">${s2fMsg}</div>
  `, s2fTone));

  // 3) SOPR (CryptoQuant via Netlify Function)
  try{
    const soprObj = await getCQ("sopr");
    const sopr = Number(soprObj?.latest?.v);
    if (Number.isFinite(sopr)) {
      let tone="neu", msg="Sideways";
      if (sopr < 1) { tone="bull"; msg="Selling at loss → possible bottom"; score += 1; }
      else if (sopr >= 1.02 && sopr <= 1.05) { tone="bull"; msg="Light profits → slow uptrend"; score += 0.5; }
      else if (Math.abs(sopr - 1.08) < 0.02) { tone="warn"; msg="Clear profit → short-term correction risk"; score -= 0.3; }
      else if (sopr >= 1.10 && sopr <= 1.15) { tone="bull"; msg="Strong profits → trend may continue"; score += 0.3; }
      else if (sopr > 1.20) { tone="bear"; msg="Very high profit → heavy selling risk"; score -= 1; }

      cards.push(card("SOPR (CryptoQuant)", `
        <div class="kv"><span>Latest</span><span>${sopr.toFixed(3)}</span></div>
        <div>${msg}</div>
      `, tone));
    } else {
      cards.push(card("SOPR (CryptoQuant)", `<div class="muted">No value returned.</div>`));
    }
  }catch(e){
    cards.push(card("SOPR (CryptoQuant)", `<div class="muted">Error: ${e.message}</div>`));
  }

  // 4) MVRV (CryptoQuant via Netlify Function)
  try{
    const mvrvObj = await getCQ("mvrv");
    const mvrv = Number(mvrvObj?.latest?.v);
    if (Number.isFinite(mvrv)) {
      let tone="neu", msg="Fair value";
      if (mvrv < 1 && mvrv >= 0.5) { tone="bull"; msg="Undervalued — buy zone"; score += 1; }
      else if (mvrv > 1 && mvrv <= 3.5) { tone="bull"; msg="Bull market regime"; score += 0.5; }
      else if (mvrv > 3.5) { tone="bear"; msg="Overvalued — risk of top"; score -= 1; }

      cards.push(card("MVRV (CryptoQuant)", `
        <div class="kv"><span>Latest</span><span>${mvrv.toFixed(2)}</span></div>
        <div>${msg}</div>
      `, tone));
    } else {
      cards.push(card("MVRV (CryptoQuant)", `<div class="muted">No value returned.</div>`));
    }
  }catch(e){
    cards.push(card("MVRV (CryptoQuant)", `<div class="muted">Error: ${e.message}</div>`));
  }

  // Render
  $("#grid").innerHTML = cards.join("");
  $("#marketScore").textContent = `${scoreLabel(score)} (${score.toFixed(1)})`;
}

main().catch(e=>{
  console.error(e);
  $("#grid").innerHTML = `<div class="card bear"><div class="title">Error</div><div>${e.message}</div></div>`;
});
</script>
</body>
</html>
