<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Market Overview (Free Data)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
    --surface: rgba(23, 26, 33, 0.92);
    --surface-hover: rgba(30, 35, 45, 0.98);
    --border: rgba(56, 68, 77, 0.4);
    --border-hover: rgba(56, 68, 77, 0.65);
    --text: #f0f2f5;
    --muted: #a8b3c0;
    --ok: #10b981;
    --warn: #f59e0b;
    --bad: #ef4444;
    --accent: #4f9cf9;
    --accent2: #9d6dfd;
    --number: #8ac8ff;
    --shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    --shadow2: 0 16px 50px rgba(0, 0, 0, 0.45);
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  @media (prefers-color-scheme: light) {
    :root {
      --bg: linear-gradient(135deg, #f9fafc 0%, #eef2f6 100%);
      --surface: rgba(255, 255, 255, 0.98);
      --surface-hover: rgba(255, 255, 255, 0.98);
      --border: rgba(203, 213, 225, 0.7);
      --border-hover: rgba(148, 163, 184, 0.6);
      --text: #1a2035;
      --muted: #64748b;
      --number: #1e40af;
      --shadow: 0 8px 32px rgba(15, 23, 42, 0.1);
      --shadow2: 0 12px 48px rgba(15, 23, 42, 0.15);
    }
  }
  
  html[data-theme="light"] {
    --bg: linear-gradient(135deg, #f9fafc 0%, #eef2f6 100%);
    --surface: rgba(255, 255, 255, 0.98);
    --surface-hover: rgba(255, 255, 255, 0.98);
    --border: rgba(203, 213, 225, 0.7);
    --border-hover: rgba(148, 163, 184, 0.6);
    --text: #1a2035;
    --muted: #64748b;
    --number: #1e40af;
  }
  
  html[data-theme="dark"] {
    --bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
    --surface: rgba(23, 26, 33, 0.92);
    --surface-hover: rgba(30, 35, 45, 0.98);
    --border: rgba(56, 68, 77, 0.4);
    --border-hover: rgba(56, 68, 77, 0.65);
    --text: #f0f2f5;
    --muted: #a8b3c0;
    --number: #8ac8ff;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    line-height: 1.55;
    min-height: 100vh;
    overflow-x: hidden;
    transition: var(--transition);
  }
  
  .wrap {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px 16px;
  }
  
  .brand {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
    justify-content: space-between;
    margin: 0 0 24px;
    padding: 16px 0;
    border-bottom: 1px solid var(--border);
  }
  
  h1 {
    margin: 0;
    font-size: clamp(24px, 4vw, 34px);
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  h1::before {
    content: "üìä";
    font-size: 1.2em;
  }
  
  .version {
    font-size: 14px;
    background: var(--surface);
    padding: 4px 8px;
    border-radius: 8px;
    color: var(--muted);
    font-weight: 600;
  }
  
  .row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .pill {
    padding: 10px 16px;
    border: 1px solid var(--border);
    border-radius: 999px;
    background: var(--surface);
    font-weight: 700;
    font-size: 14px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .pill.ok {
    border-color: var(--ok);
    background: rgba(16, 185, 129, 0.1);
  }
  
  .pill.warn {
    border-color: var(--warn);
    background: rgba(245, 158, 11, 0.1);
  }
  
  .pill.bad {
    border-color: var(--bad);
    background: rgba(239, 68, 68, 0.1);
  }
  
  .btn {
    padding: 10px 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--surface);
    color: var(--text);
    cursor: pointer;
    font-weight: 600;
    box-shadow: var(--shadow);
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn:hover {
    background: var(--surface-hover);
    transform: translateY(-2px);
    border-color: var(--border-hover);
    box-shadow: var(--shadow2);
  }
  
  .me {
    color: var(--accent);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .me::before {
    content: "üë®‚Äçüíª";
  }

  .chartWrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    box-shadow: var(--shadow);
    padding: 18px;
    margin: 0 0 24px;
    transition: var(--transition);
  }
  
  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
  }
  
  .muted {
    color: var(--muted);
    font-weight: 600;
    font-size: 14px;
  }
  
  canvas#priceChart {
    width: 100%;
    height: 360px;
    display: block;
    border-radius: 14px;
  }

  .grid {
    display: grid;
    gap: 18px;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  }
  
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    transition: var(--transition);
  }
  
  .card:hover {
    transform: translateY(-4px);
    border-color: var(--border-hover);
    box-shadow: var(--shadow2);
  }
  
  .card.ok {
    background: rgba(16, 185, 129, 0.08);
    border-color: rgba(16, 185, 129, 0.4);
  }
  
  .card.warn {
    background: rgba(245, 158, 11, 0.08);
    border-color: rgba(245, 158, 11, 0.4);
  }
  
  .card.bad {
    background: rgba(239, 68, 68, 0.08);
    border-color: rgba(239, 68, 68, 0.4);
  }
  
  .card h3 {
    margin: 0 0 12px;
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .card h3::before {
    content: "‚Ä¢";
    color: var(--accent);
    font-size: 24px;
    line-height: 0;
  }
  
  .kv {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    margin: 10px 0;
    align-items: center;
  }
  
  .kv span:first-child {
    color: var(--muted);
    font-weight: 600;
    font-size: 14px;
  }
  
  .center {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  
  .big {
    color: var(--number);
    font-size: clamp(20px, 2.8vw, 26px);
    font-weight: 800;
    letter-spacing: -0.02em;
    line-height: 1.2;
    max-width: 100%;
    word-break: break-word;
  }
  
  .card[data-tip]::after {
    content: attr(data-tip);
    position: absolute;
    left: 10px;
    right: 10px;
    bottom: 10px;
    background: rgba(0, 0, 0, 0.9);
    color: #fff;
    font-size: 13px;
    padding: 10px 12px;
    border-radius: 12px;
    opacity: 0;
    transform: translateY(8px);
    pointer-events: none;
    transition: var(--transition);
    z-index: 10;
  }
  
  html[data-theme="light"] .card[data-tip]::after {
    background: rgba(30, 34, 44, 0.95);
  }
  
  .card:hover::after {
    opacity: 1;
    transform: translateY(0);
  }
  
  .gauge {
    width: 100%;
    max-width: 240px;
    margin: auto;
  }
  
  .loader {
    width: 48px;
    height: 48px;
    border: 4px solid var(--border);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto 16px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .scroll-top {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--surface);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
    z-index: 100;
    font-size: 20px;
  }
  
  .scroll-top.visible {
    opacity: 1;
    visibility: visible;
  }
  
  .scroll-top:hover {
    background: var(--accent);
    color: white;
    transform: translateY(-4px);
    box-shadow: var(--shadow2);
  }
  
  @media (max-width: 768px) {
    .wrap {
      padding: 16px 12px;
    }
    
    .brand {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    
    .row {
      width: 100%;
      overflow-x: auto;
      padding-bottom: 8px;
      flex-wrap: nowrap;
    }
    
    .pill, .btn {
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .grid {
      grid-template-columns: 1fr;
    }
    
    canvas#priceChart {
      height: 260px;
    }
    
    .chartWrap {
      padding: 14px;
    }
    
    .card {
      padding: 18px;
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <h1>Market Overview <span class="version">v1.1</span></h1>
    <div class="row">
      <div class="pill" id="marketScore">
        <span>üìä</span>
        <span>Market Score: loading‚Ä¶</span>
      </div>
      <button class="btn" id="toggleChartBtn">
        <span>üìà</span>
        <span>Hide chart</span>
      </button>
      <button class="btn" id="refreshBtn">
        <span>‚Üª</span>
        <span>Refresh</span>
      </button>
      <button class="btn" id="themeBtn" title="Toggle theme">
        <span id="themeIcon">‚öôÔ∏è</span>
        <span>Theme: Auto</span>
      </button>
      <div class="pill me">Made by Anas Alwadi</div>
    </div>
  </div>

  <div class="chartWrap" id="chartBox">
    <div class="toolbar">
      <div class="muted">BTC/USDT ‚Äî last 180 days</div>
      <div class="muted" id="asofChart">Updating‚Ä¶</div>
    </div>
    <canvas id="priceChart" width="1080" height="360" aria-label="BTC price"></canvas>
  </div>

  <div class="grid" id="grid"></div>
  <p class="muted" id="asof" style="margin-top: 16px; text-align: center;"></p>
</div>

<div class="scroll-top" id="scrollTop">‚Üë</div>

<script>
const $ = s => document.querySelector(s);

// THEME
function applyTheme(mode) {
  document.documentElement.setAttribute("data-theme", mode === "auto" ? "auto" : mode);
  localStorage.setItem("themeMode", mode);
  $("#themeBtn span:last-child").textContent = "Theme: " + mode[0].toUpperCase() + mode.slice(1);
  
  // Update theme icon
  const icon = $("#themeIcon");
  if (mode === "light") {
    icon.textContent = "‚òÄÔ∏è";
  } else if (mode === "dark") {
    icon.textContent = "üåô";
  } else {
    icon.textContent = "‚öôÔ∏è";
  }
}

applyTheme(localStorage.getItem("themeMode") || "auto");
$("#themeBtn").addEventListener("click", () => {
  const order = ["auto", "light", "dark"];
  const cur = localStorage.getItem("themeMode") || "auto";
  applyTheme(order[(order.indexOf(cur) + 1) % order.length]);
});

// HELPERS
const fmtInt = n => Number(n).toLocaleString();

function fmtCompact(n) {
  if (n == null || !isFinite(n)) return "‚Äî";
  const abs = Math.abs(n);
  if (abs >= 1e12) return (n / 1e12).toFixed(2) + "T";
  if (abs >= 1e9) return (n / 1e9).toFixed(2) + "B";
  if (abs >= 1e6) return (n / 1e6).toFixed(2) + "M";
  if (abs >= 1e3) return (n / 1e3).toFixed(2) + "K";
  return n.toFixed(0);
}

const pct = x => (x == null || !isFinite(x)) ? "‚Äî" : (x * 100).toFixed(2) + "%";
const bust = url => url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();

async function getJSON(url) {
  try {
    const r = await fetch(bust(url), { cache: "no-store" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  } catch (e) {
    console.error("Failed to fetch " + url + ":", e);
    throw e;
  }
}

function SMA(arr, win) {
  const out = [];
  let s = 0;
  for (let i = 0; i < arr.length; i++) {
    s += arr[i];
    if (i >= win) s -= arr[i - win];
    if (i >= win - 1) out.push(s / win);
  }
  return out;
}

// SCORE (0..1)
const scoreParts = [];

function addScore(tag, val, why) {
  scoreParts.push({ tag: tag, value: val, reason: why });
}

function scoreTooltip() {
  return scoreParts.length ? scoreParts.map(p => `${p.tag}: ${(p.value > 0 ? "+" : "")}${p.value.toFixed(2)} ‚Äî ${p.reason || ""}`).join("\n") : "No components.";
}

function marketScore01() {
  if (!scoreParts.length) return { s01: .5 };
  const raw = scoreParts.reduce((a, b) => a + b.value, 0);
  const max = scoreParts.reduce((a, b) => a + Math.abs(b.value), 0) || 1;
  return { s01: (raw / max + 1) / 2 };
}

function verdict(s01) {
  if (s01 >= .75) return ["Strong Bullish üöÄ", "ok"];
  if (s01 >= .60) return ["Bullish üëç", "ok"];
  if (s01 > .40) return ["Neutral ‚ÜîÔ∏è", ""];
  if (s01 > .25) return ["Bearish ‚ö†Ô∏è", "warn"];
  return ["Strong Bearish üîª", "bad"];
}

// CHART
function drawLine(canvas, series) {
  const ctx = canvas.getContext("2d"), W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);
  if (!series.length) return;
  
  const xs = series.map(p => p.t), ys = series.map(p => p.v);
  const x0 = xs[0], x1 = xs.at(-1), minY = Math.min(...ys), maxY = Math.max(...ys);
  const padL = 50, padR = 8, padT = 8, padB = 22;
  const x = t => padL + ((t - x0) / (x1 - x0)) * (W - padL - padR);
  const y = v => H - padB - ((v - minY) / (maxY - minY)) * (H - padT - padB);
  
  // Grid
  ctx.strokeStyle = "rgba(128,128,128,.15)";
  ctx.lineWidth = 1;
  ctx.setLineDash([2, 2]);
  for (let i = 0; i <= 5; i++) {
    const gy = padT + i * (H - padT - padB) / 5;
    ctx.beginPath();
    ctx.moveTo(padL, gy);
    ctx.lineTo(W - padR, gy);
    ctx.stroke();
  }
  ctx.setLineDash([]);
  
  // Line with shadow
  const style = getComputedStyle(document.documentElement);
  ctx.strokeStyle = style.getPropertyValue('--text');
  ctx.globalAlpha = .12;
  ctx.lineWidth = 10;
  ctx.beginPath();
  series.forEach((p, i) => {
    const px = x(p.t), py = y(p.v);
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  });
  ctx.stroke();
  
  ctx.globalAlpha = 1;
  ctx.strokeStyle = style.getPropertyValue('--accent') || "#4f9cf9";
  ctx.lineWidth = 3;
  ctx.shadowColor = style.getPropertyValue('--accent') || "#4f9cf9";
  ctx.shadowBlur = 15;
  ctx.shadowOffsetY = 3;
  ctx.beginPath();
  series.forEach((p, i) => {
    const px = x(p.t), py = y(p.v);
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  });
  ctx.stroke();
  ctx.shadowColor = 'transparent';
  
  // Labels
  ctx.fillStyle = style.getPropertyValue('--muted') || "#a8b3c0";
  ctx.font = "12px 'Inter', Arial";
  ctx.fillText("$" + fmtInt(maxY.toFixed(0)), 6, y(maxY) + 4);
  ctx.fillText("$" + fmtInt(minY.toFixed(0)), 6, y(minY) + 12);
}

// GAUGE
function gaugeSVG(v) {
  const value = Math.max(0, Math.min(100, Number(v) || 0));
  const angle = (value / 100) * 180;
  const segs = [
    { a: 0, b: 36, c: "#ef4444" },
    { a: 36, b: 72, c: "#f59e0b" },
    { a: 72, b: 108, c: "#eab308" },
    { a: 108, b: 144, c: "#84cc16" },
    { a: 144, b: 180, c: "#22c55e" }
  ];
  
  const arc = (a, b) => {
    const R = 70, cx = 100, cy = 100;
    const ra = a * Math.PI / 180, rb = b * Math.PI / 180;
    const x1 = cx + R * Math.cos(ra), y1 = cy + R * Math.sin(ra);
    const x2 = cx + R * Math.cos(rb), y2 = cy + R * Math.sin(rb);
    return `M ${x1} ${y1} A ${R} ${R} 0 0 1 ${x2} ${y2}`;
  };
  
  const nx = 100 + 60 * Math.cos(angle * Math.PI / 180);
  const ny = 100 + 60 * Math.sin(angle * Math.PI / 180);
  
  return `<svg viewBox="0 0 200 130" class="gauge">
    <g>${segs.map(s => `<path d="${arc(s.a, s.b)}" stroke="${s.c}" stroke-width="12" fill="none"/>`).join("")}</g>
    <line x1="100" y1="100" x2="${nx.toFixed(1)}" y2="${ny.toFixed(1)}" stroke="var(--text)" stroke-width="3"/>
    <circle cx="100" cy="100" r="5" fill="var(--text)"/>
    <text x="100" y="120" text-anchor="middle" font-size="14" fill="var(--text)" font-weight="600">${Math.round(value)}</text>
  </svg>`;
}

// CARDS
function card(title, html, tone = "", tip = "") {
  const cls = tone === "bull" ? "ok" : tone === "warn" ? "warn" : tone === "bear" ? "bad" : "";
  const tipAttr = tip ? ` data-tip="${tip.replace(/"/g, '&quot;')}"` : "";
  return `<div class="card ${cls}"${tipAttr}><h3>${title}</h3>${html}</div>`;
}

// ENDPOINTS
const CG_PRICE = "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd";
const CG_GLOBAL = "https://api.coingecko.com/api/v3/global";
const CG_COIN = "https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false";
const CG_MKTCHART = "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=180&interval=daily";
const FNG = "https://api.alternative.me/fng/?limit=2";
const BCH_HASH = "https://api.blockchain.info/charts/hash-rate?timespan=60days&format=json&cors=true";
const BCH_DIFF = "https://api.blockchain.info/charts/difficulty?timespan=60days&format=json&cors=true";
const BCH_ADDR = "https://api.blockchain.info/charts/n-unique-addresses?timespan=60days&format=json&cors=true";
const BCH_TXV_USD = "https://api.blockchain.info/charts/estimated-transaction-volume-usd?timespan=180days&format=json&cors=true";
const BCH_FEES_USD = "https://api.blockchain.info/charts/transaction-fees-usd?timespan=60days&format=json&cors=true";
const BCH_UTXO = "https://api.blockchain.info/charts/utxo-count?timespan=60days&format=json&cors=true";
const MEMPOOL_FEES = "https://mempool.space/api/v1/fees/recommended";

// MAIN
async function main() {
  // Show loading indicator
  $("#grid").innerHTML = `
    <div class="center" style="grid-column:1/-1;padding:40px 0">
      <div class="loader"></div>
      <p class="muted">Loading market data...</p>
    </div>`;
    
  $("#refreshBtn").disabled = true;
  $("#asof").textContent = "Updating‚Ä¶";
  $("#asofChart").textContent = "Updating‚Ä¶";
  const cards = [];
  scoreParts.length = 0;

  // Core + chart
  let supply = null, priceUSD = null, txvSeries = [];
  try {
    const [g, p, coin, chart, txv] = await Promise.all([
      getJSON(CG_GLOBAL), 
      getJSON(CG_PRICE), 
      getJSON(CG_COIN), 
      getJSON(CG_MKTCHART), 
      getJSON(BCH_TXV_USD)
    ]);
    
    const series = (chart.prices || []).map(([t, v]) => ({ t: Math.floor(t / 1000), v }));
    drawLine($("#priceChart"), series);
    $("#asofChart").textContent = "Last: " + new Date(series.at(-1).t * 1000).toLocaleDateString();

    priceUSD = p.bitcoin.usd;
    const btcCap = coin.market_data.market_cap.usd;
    const dominance = g.data.market_cap_percentage.btc;
    const totalM = g.data.total_market_cap.usd;
    const vol24 = g.data.total_volume.usd;
    supply = coin.market_data.circulating_supply || (btcCap && priceUSD ? btcCap / priceUSD : null);
    const altM = Math.max(0, totalM - btcCap);
    const liqRatio = (totalM > 0) ? vol24 / totalM : null;

    // Cards
    cards.push(card("BTC Price", `<div class="center big">$${fmtCompact(priceUSD)}</div>`));
    cards.push(card("BTC Dominance", `<div class="center big">${dominance.toFixed(1)}%</div>`, dominance >= 55 ? "bull" : dominance <= 45 ? "warn" : "", "BTC share of the total crypto market."));
    cards.push(card("Total Market Cap", `<div class="center big">$${fmtCompact(totalM)}</div>`));
    cards.push(card("Altcoin Market Cap", `<div class="center big">$${fmtCompact(altM)}</div>`));
    cards.push(card("24h Total Volume", `<div class="center big">$${fmtCompact(vol24)}</div>`));
    cards.push(card("Volume / Market Cap", `<div class="center big">${liqRatio != null ? (liqRatio * 100).toFixed(2) + "%" : "‚Äî"}</div>`));

    if (dominance >= 55) addScore("BTC Dominance", +0.40, "‚â•55% favors BTC strength");
    else if (dominance <= 45) addScore("BTC Dominance", -0.20, "‚â§45% weak BTC share");

    // Save series for NVT/GC
    txvSeries = (txv.values || []).map(o => ({ t: o.x, v: o.y }));
    
    // S2F
    const flowYear = 3.125 * 144 * 365;
    const s2f = supply ? (supply / flowYear) : null;
    let s2fTone = "", s2fMsg = "Informational only";
    if (s2f != null && s2f > 100) {
      s2fTone = "bull";
      s2fMsg = "High scarcity";
      addScore("S2F (approx)", +0.20, "High scarcity");
    }
    cards.push(card("Stock-to-Flow (approx)",
      `<div class="kv"><span>Stock</span><span class="big">${supply ? fmtCompact(supply) + " BTC" : "‚Äî"}</span></div>
       <div class="kv"><span>Flow / year</span><span>${fmtCompact(flowYear)} BTC</span></div>
       <div class="center big">${s2f ? s2f.toFixed(1) : "‚Äî"}</div>
       <div class="muted">${s2fMsg}</div>`, s2fTone));
  } catch (e) {
    cards.push(card("Core Data", `<div class="muted">Error: ${e.message}</div>`, "warn"));
  }

  // Fear & Greed
  try {
    const f = await getJSON(FNG);
    const now = f?.data?.[0];
    if (now) {
      const v = Number(now.value);
      let tone = "", msg = "Neutral";
      if (v <= 25) {
        tone = "bear";
        msg = "Extreme fear";
        addScore("Fear & Greed", -0.80, "Extreme fear");
      } else if (v <= 45) {
        tone = "warn";
        msg = "Fear";
        addScore("Fear & Greed", -0.40, "Fear");
      } else if (v >= 75) {
        tone = "warn";
        msg = "Extreme greed";
        addScore("Fear & Greed", -0.40, "Extreme greed");
      } else if (v >= 55) {
        tone = "bull";
        msg = "Greed";
        addScore("Fear & Greed", +0.20, "Greed");
      }
      cards.push(card("Fear & Greed (Gauge)",
        `<div class="center">${gaugeSVG(v)}</div>
         <div class="center muted">${now.value_classification} ‚Äî ${new Date(Number(now.timestamp) * 1000).toLocaleDateString()}</div>`, tone));
    }
  } catch (e) {
    cards.push(card("Fear & Greed", `<div class="muted">Error: ${e.message}</div>`, "warn"));
  }

  // Hashrate / Difficulty / Active Addresses
  async function addBC(title, url, unit, thUp, thDn, scoreTag, upS, downS, tip) {
    try {
      const j = await getJSON(url);
      const pts = j?.values || [];
      const last = pts.at(-1), prev = pts.at(-8);
      const latest = last?.y;
      const ch = (latest && prev) ? (latest - prev.y) / prev.y : null;
      let tone = "", msg = "Flat";
      
      if (ch != null) {
        if (ch > thUp) {
          tone = "bull";
          msg = "Rising";
          if (upS) addScore(scoreTag, upS, "Rising");
        } else if (ch < thDn) {
          tone = "warn";
          msg = "Falling";
          if (downS) addScore(scoreTag, downS, "Falling");
        }
      }
      cards.push(card(title,
        `<div class="kv"><span>Latest</span><span class="big">${latest ? fmtCompact(latest) + (unit ? " " + unit : "") : "‚Äî"}</span></div>
         <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
         <div class="muted">${msg}</div>`, tone, tip || ""));
    } catch (e) {
      cards.push(card(title, `<div class="muted">Error: ${e.message}</div>`, "warn"));
    }
  }
  
  await addBC("Hashrate", BCH_HASH, "EH/s", 0.05, -0.05, "Hashrate", +0.30, -0.20);
  await addBC("Mining Difficulty", BCH_DIFF, "", 0.03, -0.03, "Difficulty", +0.20, -0.10);
  await addBC("Active Addresses", BCH_ADDR, "", 0.05, -0.05, "Active Addresses", +0.30, -0.20);

  // Fees (USD) + fallback mempool.space
  try {
    const f = await getJSON(BCH_FEES_USD);
    const pts = f?.values || [];
    const last = pts.at(-1), prev = pts.at(-8);
    const feesUSD = last?.y || null;
    const ch = (feesUSD && prev) ? (feesUSD - prev.y) / prev.y : null;
    let tone = "", msg = "Normal";
    
    if (ch != null) {
      if (ch > 0.25) {
        tone = "warn";
        msg = "Congestion";
        addScore("Fees", -0.20, "Congestion");
      } else if (ch < -0.25) {
        tone = "bull";
        msg = "Low fees";
        addScore("Fees", +0.10, "Low fees");
      }
    }
    cards.push(card("Daily Fees",
      `<div class="center big">${feesUSD ? "$" + fmtCompact(feesUSD) : "‚Äî"}</div>
       <div class="kv"><span>~7d Change</span><span>${pct(ch)}</span></div>
       <div class="muted">${msg}</div>`, tone));
  } catch (e) {
    try {
      const m = await getJSON(MEMPOOL_FEES);
      cards.push(card("Current Fees",
        `<div class="kv"><span>Fast</span><span class="big">${m.fastestFee} sat/vB</span></div>
         <div class="kv"><span>Standard</span><span>${m.halfHourFee} sat/vB</span></div>
         <div class="kv"><span>Economy</span><span>${m.hourFee} sat/vB</span></div>`));
    } catch (e2) {
      cards.push(card("Fees", `<div class="muted">Error: ${e.message}</div>`, "warn"));
    }
  }

  // NVT + NVT Golden Cross
  try {
    const priceSeriesResp = await getJSON(CG_MKTCHART);
    const priceSeries = (priceSeriesResp.prices || []).map(([t, v]) => v);
    const txv = txvSeries.map(p => p.v);
    const n = Math.min(priceSeries.length, txv.length);
    const supplyGuess = supply || 19_000_000;
    const nvtSeries = [];
    
    for (let i = 0; i < n; i++) {
      const mcap = priceSeries[priceSeries.length - n + i] * supplyGuess;
      const vol = txv[txv.length - n + i] || 0.0001;
      nvtSeries.push(mcap / vol);
    }
    
    const latestNVT = nvtSeries.at(-1);
    let tone = "", msg = "Neutral zone";
    
    if (latestNVT > 150) {
      tone = "warn";
      msg = "High valuation";
      addScore("NVT", -0.20, "High valuation");
    } else if (latestNVT < 50) {
      tone = "bull";
      msg = "Low valuation";
      addScore("NVT", +0.20, "Low valuation");
    }
    
    cards.push(card("NVT (Market Cap √∑ Tx Volume)",
      `<div class="center big">${latestNVT ? latestNVT.toFixed(1) : "‚Äî"}</div>
       <div class="muted">${msg}</div>`, tone));
    
    // Golden Cross
    const nvt10 = SMA(nvtSeries, 10), nvt30 = SMA(nvtSeries, 30);
    let gc = null;
    
    if (nvt10.length && nvt30.length) {
      const last10 = nvt10.at(-1), last30 = nvt30.at(-1);
      gc = ((last10 / last30) - 1) * 100;
    }
    
    let gcTone = "", gcMsg = "Fair value";
    
    if (gc != null) {
      if (gc > 5) {
        gcTone = "warn";
        gcMsg = "Overvalue (GC>+5%)";
        addScore("NVT Golden Cross", -0.20, "Overvalue");
      } else if (gc < -5) {
        gcTone = "bull";
        gcMsg = "Undervalue (GC<-5%)";
        addScore("NVT Golden Cross", +0.20, "Undervalue");
      }
    }
    
    cards.push(card("NVT Golden Cross (approx)",
      `<div class="center big">${gc != null ? gc.toFixed(2) + "%" : "‚Äî"}</div>
       <div class="muted">${gcMsg}</div>`, gcTone));
  } catch (e) {
    cards.push(card("NVT", `<div class="muted">Error: ${e.message}</div>`, "warn"));
  }

  // Finalize
  const { s01 } = marketScore01();
  const [lab, cls] = verdict(s01);
  const pill = $("#marketScore");
  pill.innerHTML = `<span>üìä</span><span>Market Score: ${lab} (${s01.toFixed(2)})</span>`;
  pill.className = "pill " + (cls || "");
  pill.title = scoreTooltip();

  $("#grid").innerHTML = cards.join("");
  $("#asof").textContent = "Last updated: " + new Date().toLocaleString();
  $("#refreshBtn").disabled = false;
}

// UI
$("#toggleChartBtn").addEventListener("click", () => {
  const box = $("#chartBox");
  if (box.style.display === "none") {
    box.style.display = "block";
    $("#toggleChartBtn span:last-child").textContent = "Hide chart";
  } else {
    box.style.display = "none";
    $("#toggleChartBtn span:last-child").textContent = "Show chart";
  }
});

$("#refreshBtn").addEventListener("click", main);

// Scroll to top
const scrollTopBtn = $("#scrollTop");
window.addEventListener("scroll", () => {
  scrollTopBtn.classList.toggle("visible", window.scrollY > 300);
});

scrollTopBtn.addEventListener("click", () => {
  window.scrollTo({ top: 0, behavior: "smooth" });
});

// Start
main();
</script>
</body>
</html>
