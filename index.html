<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Market Overview</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

  :root{
    --bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
    --surface: rgba(23, 26, 33, 0.8);
    --surface-hover: rgba(30, 35, 45, 0.9);
    --border: rgba(56, 68, 77, 0.3);
    --border-hover: rgba(56, 68, 77, 0.6);
    --text: #e6e8eb;
    --text-secondary: #9aa0a6;
    --ok: #10b981;
    --warn: #f59e0b;
    --bad: #ef4444;
    --accent: #3b82f6;
    --accent-secondary: #8b5cf6;
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --card-shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.4);
    --glow: 0 0 20px rgba(59, 130, 246, 0.3);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --surface: rgba(255, 255, 255, 0.9);
      --surface-hover: rgba(248, 250, 252, 1);
      --border: rgba(226, 232, 240, 0.8);
      --border-hover: rgba(148, 163, 184, 0.6);
      --text: #1e293b;
      --text-secondary: #64748b;
      --card-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
      --card-shadow-hover: 0 12px 48px rgba(15, 23, 42, 0.12);
      --glow: 0 0 20px rgba(59, 130, 246, 0.2);
    }
  }
  html[data-theme="light"]{
    --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    --surface: rgba(255, 255, 255, 0.9);
    --surface-hover: rgba(248, 250, 252, 1);
    --border: rgba(226, 232, 240, 0.8);
    --border-hover: rgba(148, 163, 184, 0.6);
    --text: #1e293b;
    --text-secondary: #64748b;
    --card-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
    --card-shadow-hover: 0 12px 48px rgba(15, 23, 42, 0.12);
    --glow: 0 0 20px rgba(59, 130, 246, 0.2);
  }
  html[data-theme="dark"]{
    --bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
    --surface: rgba(23, 26, 33, 0.8);
    --surface-hover: rgba(30, 35, 45, 0.9);
    --border: rgba(56, 68, 77, 0.3);
    --border-hover: rgba(56, 68, 77, 0.6);
    --text: #e6e8eb;
    --text-secondary: #9aa0a6;
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --card-shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.4);
    --glow: 0 0 20px rgba(59, 130, 246, 0.3);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    line-height:1.6;min-height:100vh;overflow-x:hidden
  }
  body::before{
    content:'';position:fixed;inset:0;pointer-events:none;z-index:-1;
    background:
      radial-gradient(circle at 20% 80%, rgba(59,130,246,.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(139,92,246,.1) 0%, transparent 50%);
  }
  .wrap{max-width:1400px;margin:0 auto;padding:24px 20px}
  .brand{display:flex;gap:16px;justify-content:space-between;align-items:center;margin:0 0 32px;padding:24px 0;border-bottom:1px solid var(--border)}
  .brand h1{font-size:clamp(24px,4vw,32px);font-weight:700;margin:0;
    background:linear-gradient(135deg,var(--accent) 0%,var(--accent-secondary) 100%);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .me{color:var(--warn);font-weight:600;font-size:14px;padding:8px 16px;background:rgba(245,158,11,.1);border-radius:20px;border:1px solid rgba(245,158,11,.2)}
  .btn{background:var(--surface);backdrop-filter:blur(10px);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 16px;cursor:pointer;box-shadow:var(--card-shadow);font-weight:500;font-size:14px;transition:.3s}
  .btn:hover{background:var(--surface-hover);border-color:var(--border-hover);box-shadow:var(--card-shadow-hover);transform:translateY(-2px)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .pill{padding:10px 20px;border:1px solid var(--border);border-radius:25px;background:var(--surface);backdrop-filter:blur(10px);font-weight:600;font-size:14px;box-shadow:var(--card-shadow)}
  .grid{display:grid;gap:24px;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));align-items:stretch;margin-bottom:32px}
  .card{background:var(--surface);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:20px;padding:20px;min-height:200px;display:flex;flex-direction:column;justify-content:space-between;box-shadow:var(--card-shadow);position:relative;transition:.3s}
  .card:hover{background:var(--surface-hover);border-color:var(--border-hover);box-shadow:var(--card-shadow-hover);transform:translateY(-4px) scale(1.02)}
  .card h3{margin:0 0 8px;font-size:15px;font-weight:600;color:var(--text);letter-spacing:-.02em}
  .kv{display:flex;justify-content:space-between;gap:16px;margin:8px 0;align-items:center}
  .kv span:first-child{font-size:13px;color:var(--text-secondary);font-weight:500}
  .kv span:last-child{font-weight:600;color:var(--text)}
  .big{font-size:clamp(20px,3vw,26px);font-weight:800;letter-spacing:-.02em}
  .muted{color:var(--text-secondary);font-size:12.5px}
  .ok{border-color:var(--ok);background:rgba(16,185,129,.05)}
  .warn{border-color:var(--warn);background:rgba(245,158,11,.05)}
  .bad{border-color:var(--bad);background:rgba(239,68,68,.05)}
  .card[data-tip]::after{content:attr(data-tip);position:absolute;left:16px;right:16px;bottom:16px;background:rgba(0,0,0,.9);color:#fff;font-size:12px;line-height:1.4;padding:10px 12px;border-radius:12px;opacity:0;transform:translateY(8px);pointer-events:none;transition:.3s;backdrop-filter:blur(10px);z-index:10}
  html[data-theme="light"] .card[data-tip]::after{background:rgba(30,34,44,.95)}
  .card:hover::after{opacity:1;transform:translateY(0)}
  .chartWrap{background:var(--surface);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:20px;padding:20px;margin:0 0 32px;box-shadow:var(--card-shadow)}
  canvas#priceChart{width:100%;height:360px;display:block;border-radius:12px}
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border)}
  .gauge{width:100%;max-width:260px;margin:auto;filter:drop-shadow(0 4px 8px rgba(0,0,0,.1))}
  /* الرقم في وسط البطاقة */
  .centerBox{flex:1;display:grid;place-items:center;padding:4px 6px}

  @media (max-width:768px){
    .wrap{padding:16px 12px}
    .brand{flex-direction:column;gap:12px;text-align:center}
    .grid{grid-template-columns:1fr;gap:16px}
    canvas#priceChart{height:300px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <h1>Market Overview</h1>
    <div class="row">
      <div class="pill" id="marketScore">Market Score: loading…</div>
      <button class="btn" id="toggleChartBtn">Hide chart</button>
      <button class="btn" id="refreshBtn">Refresh</button>
      <button class="btn" id="themeBtn" title="Toggle theme">Theme: Auto</button>
      <div class="me">Made by Anas Alwadi</div>
    </div>
  </div>

  <div class="chartWrap" id="chartBox">
    <div class="toolbar">
      <div class="muted">BTC/USDT — last 180 days</div>
      <div class="muted" id="asofChart">Updating…</div>
    </div>
    <canvas id="priceChart" width="1080" height="340" aria-label="BTC price"></canvas>
  </div>

  <div class="grid" id="grid"></div>
  <p class="muted" id="asof" style="margin-top:10px"></p>
</div>

<script>
const $ = s => document.querySelector(s);
const bust = url => url + (url.includes("?")?"&":"?") + "t=" + Date.now();

// أرقام مختصرة K/M/B/T
function compact(n, withSymbol){
  if(n==null || !isFinite(n)) return "—";
  const abs = Math.abs(n);
  const units = [{v:1e12,s:"T"},{v:1e9,s:"B"},{v:1e6,s:"M"},{v:1e3,s:"K"}];
  for (const u of units){
    if (abs >= u.v) return (n/u.v).toFixed(2).replace(/\.0+$/,"") + (withSymbol?(" "+u.s):u.s);
  }
  return Number(n).toLocaleString();
}

// Theme toggle (auto/light/dark)
function applyTheme(mode){
  const html=document.documentElement;
  html.setAttribute("data-theme", mode);
  localStorage.setItem("themeMode", mode);
  $("#themeBtn").textContent = "Theme: " + mode[0].toUpperCase()+mode.slice(1);
}
(function(){
  const saved = localStorage.getItem("themeMode") || "auto";
  applyTheme(saved);
})();
$("#themeBtn").addEventListener("click", ()=>{
  const order=["auto","light","dark"];
  const cur=localStorage.getItem("themeMode")||"auto";
  const next=order[(order.indexOf(cur)+1)%order.length];
  applyTheme(next);
});

// Data sources
const CG_GLOBAL   = "https://api.coingecko.com/api/v3/global";
const CG_COIN     = "https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false";
const CG_MKTCHART = "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=180&interval=daily";
const FNG         = "https://api.alternative.me/fng/?limit=2";
const BCH_HASH    = "https://api.blockchain.info/charts/hash-rate?timespan=60days&format=json&cors=true";
const BCH_DIFF    = "https://api.blockchain.info/charts/difficulty?timespan=60days&format=json&cors=true";
const BCH_ADDR    = "https://api.blockchain.info/charts/n-unique-addresses?timespan=60days&format=json&cors=true";
const BCH_TXV_USD = "https://api.blockchain.info/charts/estimated-transaction-volume-usd?timespan=180days&format=json&cors=true";
const BCH_FEES_USD= "https://api.blockchain.info/charts/transaction-fees-usd?timespan=60days&format=json&cors=true";
const MEMPOOL_FEES = "https://mempool.space/api/v1/fees/recommended";
const MEMPOOL_STATS= "https://mempool.space/api/mempool";

async function getJSON(url){
  const r = await fetch(bust(url), {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
function drawPriceChart(canvas, series){
  const ctx=canvas.getContext("2d");
  const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  if(!series.length) return;
  const xs=series.map(p=>p.t), ys=series.map(p=>p.v);
  const x0=xs[0], x1=xs[xs.length-1];
  const minY=Math.min(...ys), maxY=Math.max(...ys);
  const padL=50,padR=10,padT=10,padB=24;
  const x=t=>padL+((t-x0)/(x1-x0))*(W-padL-padR);
  const y=v=>H-padB-((v-minY)/(maxY-minY))*(H-padT-padB);
  ctx.strokeStyle="rgba(128,128,128,.25)";ctx.lineWidth=1;
  for(let i=0;i<=5;i++){const gy=padT+i*(H-padT-padB)/5;ctx.beginPath();ctx.moveTo(padL,gy);ctx.lineTo(W-padR,gy);ctx.stroke();}
  ctx.strokeStyle="#3b82f6";ctx.lineWidth=1.6;ctx.beginPath();
  series.forEach((p,i)=>{const px=x(p.t),py=y(p.v);if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);});ctx.stroke();
  ctx.fillStyle="rgba(160,160,170,.9)";ctx.font="12px Inter,Arial";ctx.fillText("$"+Math.round(maxY).toLocaleString(),6,y(maxY)+4);ctx.fillText("$"+Math.round(minY).toLocaleString(),6,y(minY)+12);
}

// Gauge SVG
function gaugeSVG(value){
  const v=Math.max(0,Math.min(100,Number(value)||0));
  const angle=(v/100)*180;
  const segs=[{a:0,b:36,c:"#ff4d4d"},{a:36,b:72,c:"#ffb84d"},{a:72,b:108,c:"#cccc66"},{a:108,b:144,c:"#88cc66"},{a:144,b:180,c:"#33aa55"}];
  const arc=(a,b)=>{const r=70,cx=100,cy=100,ra=a*Math.PI/180,rb=b*Math.PI/180,x1=cx+r*Math.cos(ra),y1=cy+r*Math.sin(ra),x2=cx+r*Math.cos(rb),y2=cy+r*Math.sin(rb);return `M ${x1} ${y1} A ${r} ${r} 0 0 1 ${x2} ${y2}`;};
  const nx=100+60*Math.cos(angle*Math.PI/180), ny=100+60*Math.sin(angle*Math.PI/180);
  return `<svg viewBox="0 0 200 130" class="gauge" style="transform: rotateX(180deg) rotateY(180deg);">
    <g>${segs.map(s=>`<path d="${arc(s.a,s.b)}" stroke="${s.c}" stroke-width="12" fill="none"/>`).join("")}</g>
    <line x1="100" y1="100" x2="${nx.toFixed(1)}" y2="${ny.toFixed(1)}" stroke="var(--text)" stroke-width="3"/><circle cx="100" cy="100" r="5" fill="var(--text)"/>
    <text x="100" y="120" text-anchor="middle" font-size="14" fill="var(--text)" font-family="Inter,Arial">${Math.round(v)}</text>
  </svg>`;
}

// بطاقة موحّدة: رقم كبير في الوسط + محتوى إضافي اختياري
function card(title, numberHtml, extraHtml="", tone="", tip=""){
  const cls = tone==="bull"?"ok":tone==="warn"?"warn":tone==="bear"?"bad":"";
  const tipAttr = tip ? ` data-tip="${tip.replace(/"/g,'&quot;')}"` : "";
  return `
    <div class="card ${cls}"${tipAttr}>
      <h3>${title}</h3>
      <div class="centerBox">${numberHtml}</div>
      ${extraHtml}
    </div>`;
}

function scoreLabel(x){ if(x>=2.5) return `Bullish (${x.toFixed(1)})`; if(x<=-2.5) return `Bearish (${x.toFixed(1)})`; return `Neutral (${x.toFixed(1)})`; }

async function main(){
  $("#grid").innerHTML=""; $("#refreshBtn").disabled=true;
  $("#asof").textContent="Updating…"; $("#asofChart").textContent="Updating…";

  let score=0; const cards=[];

  // ---------------- Core + Chart ----------------
  let priceUSD=null, dominance=null, totalM=null, altM=null, vol24=null, supply=null, btcCap=null;
  // سنستخدم هذه لاحقًا لحساب NVT
  let txUSD = null;

  try{
    const [g, coin, chart] = await Promise.all([
      getJSON(CG_GLOBAL),
      getJSON(CG_COIN),
      getJSON(CG_MKTCHART)
    ]);

    priceUSD = coin?.market_data?.current_price?.usd ?? null;
    btcCap   = coin?.market_data?.market_cap?.usd ?? null;
    supply   = coin?.market_data?.circulating_supply ?? null;

    dominance = g?.data?.market_cap_percentage?.btc ?? null;
    totalM    = g?.data?.total_market_cap?.usd ?? null;
    vol24     = g?.data?.total_volume?.usd ?? null;
    altM      = (totalM!=null && btcCap!=null) ? Math.max(0, totalM - btcCap) : null;

    const s = (chart?.prices||[]).map(([t,v])=>({t:Math.floor(t/1000), v}));
    drawPriceChart(document.getElementById("priceChart"), s);
    if(s.length) $("#asofChart").textContent = "Last: " + new Date(s[s.length-1].t*1000).toLocaleDateString();

    // بطاقات BTC (بدون ذكر المصدر)
    cards.push(card("BTC Price", `<div class="big">$${compact(priceUSD,true)}</div>`));

    let domTone="";
    if(dominance>=55){ domTone="bull"; score+=0.4; }
    else if(dominance<=45){ domTone="warn"; score-=0.2; }
    cards.push(card("BTC Dominance", `<div class="big">${dominance!=null?dominance.toFixed(1):"—"}%</div>`, "", domTone, "BTC share of total crypto market."));

    cards.push(card("Total Market Cap", `<div class="big">$${compact(totalM,true)}</div>`));
    cards.push(card("Altcoin Market Cap", `<div class="big">$${compact(altM,true)}</div>`));
    cards.push(card("24h Total Volume", `<div class="big">$${compact(vol24,true)}</div>`));
    cards.push(card("Volume / Market Cap", `<div class="big">${(totalM && vol24)?(vol24/totalM*100).toFixed(2)+"%":"—"}</div>`));

    // S2F (تقريبي)
    const flowYear = 3.125 * 144 * 365;
    const s2f = (supply!=null) ? (supply/flowYear) : null;
    let s2fTone="", s2fMsg="Informational only";
    if(s2f!=null && s2f>100){ s2fTone="bull"; s2fMsg="High scarcity"; score+=0.2; }
    cards.push(card("Stock-to-Flow (approx)",
      `<div class="big">${s2f!=null? s2f.toFixed(1) : "—"}</div>`,
      `<div class="kv"><span>Stock (circulating)</span><span>${supply?compact(supply,true)+" BTC":"—"}</span></div>
       <div class="kv"><span>Flow / year (est.)</span><span>${compact(flowYear,true)} BTC</span></div>
       <div class="muted">${s2fMsg}</div>`, s2fTone, "Approx: subsidy × blocks/day × 365"
    ));
  }catch(e){
    console.error("BTC Core data error:", e);
    cards.push(card("Core Data", `<div class="big">—</div>`, `<div class="muted">Error: ${e.message}</div>`, "warn"));
  }

  // ---------------- Fear & Greed ----------------
  try{
    const f = await getJSON(FNG);
    const now = f?.data?.[0];
    if(now){
      const v = Number(now.value);
      let tone=""; if(v<=25){tone="bear";score-=.8;} else if(v<=45){tone="warn";score-=.4;} else if(v>=75){tone="warn";score-=.4;} else if(v>=55){tone="bull";score+=.2;}
      const gauge = `<div class="centerBox">${gaugeSVG(v)}</div>
        <div class="muted" style="text-align:center">${now.value_classification} — ${new Date(Number(now.timestamp)*1000).toLocaleDateString()}</div>`;
      cards.push(card("Fear & Greed (Gauge)", "", gauge, tone, "0=extreme fear, 100=extreme greed."));
    }
  }catch(e){
    cards.push(card("Fear & Greed", `<div class="big">—</div>`, `<div class="muted">Error: ${e.message}</div>`));
  }

  // ---------------- Hashrate ----------------
  try{
    const h = await getJSON(BCH_HASH);
    const pts=h?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="—"; if(ch!=null){ if(ch>.05){tone="bull";msg="Rising";score+=.3;} else if(ch<-.05){tone="warn";msg="Falling";score-=.2;} }
    cards.push(card("Hashrate", `<div class="big">${latest?compact(latest,false):"—"} EH/s</div>`,
      `<div class="kv"><span>~7d Change</span><span>${ch!=null?(ch*100).toFixed(2)+"%":"—"}</span></div>
       <div class="muted">${msg}</div>`, tone));
  }catch(e){ cards.push(card("Hashrate", `<div class="big">—</div>`, `<div class="muted">Error: ${e.message}</div>`)); }

  // ---------------- Difficulty ----------------
  try{
    const d = await getJSON(BCH_DIFF);
    const pts=d?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="—"; if(ch!=null){ if(ch>.03){tone="bull";msg="Trending up";score+=.2;} else if(ch<-.03){tone="warn";msg="Trending down";score-=.1;} }
    cards.push(card("Mining Difficulty", `<div class="big">${latest?compact(latest,false):"—"}</div>`,
      `<div class="kv"><span>~7d Change</span><span>${ch!=null?(ch*100).toFixed(2)+"%":"—"}</span></div>
       <div class="muted">${msg}</div>`, tone));
  }catch(e){ cards.push(card("Mining Difficulty", `<div class="big">—</div>`, `<div class="muted">Error: ${e.message}</div>`)); }

  // ---------------- Active Addresses ----------------
  try{
    const a = await getJSON(BCH_ADDR);
    const pts=a?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const latest=last?.y, ch=(latest&&prev)?(latest-prev.y)/prev.y:null;
    let tone="", msg="—"; if(ch!=null){ if(ch>.05){tone="bull";msg="Activity up";score+=.3;} else if(ch<-.05){tone="warn";msg="Activity down";score-=.2;} }
    cards.push(card("Active Addresses", `<div class="big">${latest?compact(latest,false):"—"}</div>`,
      `<div class="kv"><span>~7d Change</span><span>${ch!=null?(ch*100).toFixed(2)+"%":"—"}</span></div>
       <div class="muted">${msg}</div>`, tone));
  }catch(e){ cards.push(card("Active Addresses", `<div class="big">—</div>`, `<div class="muted">Error: ${e.message}</div>`)); }

  // ---------------- Fees (daily) ----------------
  try{
    const f = await getJSON(BCH_FEES_USD);
    const pts=f?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    const feesUSD=last?.y||null; const ch=(feesUSD&&prev)?(feesUSD-prev.y)/prev.y:null;
    let tone="", msg="—"; if(ch!=null){ if(ch>.25){tone="warn";msg="Congestion";score-=.2;} else if(ch<-.25){tone="bull";msg="Low fees";score+=.1;} }
    cards.push(card("Daily Fees", `<div class="big">${feesUSD?"$"+compact(feesUSD,true):"—"}</div>`,
      `<div class="kv"><span>~7d Change</span><span>${ch!=null?(ch*100).toFixed(2)+"%":"—"}</span></div>
       <div class="muted">${msg}</div>`, tone));
  }catch(e){
    try{
      const mem = await getJSON(MEMPOOL_FEES);
      cards.push(card("Current Fees",
        `<div class="big">${mem.fastestFee} sat/vB</div>`,
        `<div class="kv"><span>Standard</span><span>${mem.halfHourFee} sat/vB</span></div>
         <div class="kv"><span>Economy</span><span>${mem.hourFee} sat/vB</span></div>`));
    }catch(e2){
      cards.push(card("Fees", `<div class="big">—</div>`, `<div class="muted">Error: ${e.message}</div>`));
    }
  }

  // ---------------- Tx Volume (USD) + NVT ----------------
  try{
    const t = await getJSON(BCH_TXV_USD);
    const pts=t?.values||[]; const last=pts[pts.length-1], prev=pts[pts.length-8];
    txUSD = last?.y ?? null;
    const ch=(txUSD&&prev)?(txUSD-prev.y)/prev.y:null;
    let tone="", msg="—"; if(ch!=null){ if(ch>.05){tone="bull";msg="Volume up";score+=.2;} else if(ch<-.05){tone="warn";msg="Volume down";score-=.1;} }
    cards.push(card("Transaction Volume (USD)", `<div class="big">${txUSD?"$"+compact(txUSD,true):"—"}</div>`,
      `<div class="kv"><span>~7d Change</span><span>${ch!=null?(ch*100).toFixed(2)+"%":"—"}</span></div>
       <div class="muted">${msg}</div>`, tone));
  }catch(e){ cards.push(card("Transaction Volume (USD)", `<div class="big">—</div>`, `<div class="muted">Error: ${e.message}</div>`)); }

  // NVT محلي
  const nvt = (btcCap && txUSD) ? (btcCap/txUSD) : null;
  let nvtTone="", nvtMsg="Normal range";
  if(nvt!=null){
    if(nvt>150){ nvtTone="warn"; nvtMsg="High valuation"; score -= .2; }
    else if(nvt<50){ nvtTone="bull"; nvtMsg="Low valuation"; score += .2; }
  }
  cards.push(card("NVT Ratio", `<div class="big">${nvt!=null?nvt.toFixed(1):"—"}</div>`,
    `<div class="kv"><span>BTC Market Cap</span><span>$${btcCap?compact(btcCap,true):"—"}</span></div>
     <div class="kv"><span>Tx Volume (USD)</span><span>$${txUSD?compact(txUSD,true):"—"}</span></div>
     <div class="muted">${nvtMsg}</div>`, nvtTone, "NVT = Market Cap ÷ Daily Tx Volume"
  ));

  // ---------------- Mempool Status ----------------
  try{
    const mem = await getJSON(MEMPOOL_STATS);
    const count=mem?.count||0, vsize=mem?.vsize||0, totalFees=mem?.total_fee||0;
    let tone="", msg="Normal"; if(count>50000){tone="warn";msg="Congested";score-=.2;} else if(count<5000){tone="bull";msg="Clear";score+=.1;}
    cards.push(card("Mempool Status", `<div class="big">${compact(count,false)} TXs</div>`,
      `<div class="kv"><span>Size (vMB)</span><span>${(vsize/1e6).toFixed(1)}</span></div>
       <div class="kv"><span>Total Fees</span><span>${(totalFees/1e8).toFixed(2)} BTC</span></div>
       <div class="muted">${msg}</div>`, tone));
  }catch(e){ cards.push(card("Mempool Status", `<div class="big">—</div>`, `<div class="muted">Error: ${e.message}</div>`)); }

  // ---------------- Score + render ----------------
  document.getElementById("marketScore").textContent = "Market Score: " + scoreLabel(score);
  document.getElementById("grid").innerHTML = cards.join("");
  document.getElementById("asof").textContent = "Last updated: " + new Date().toLocaleString();
  document.getElementById("refreshBtn").disabled = false;
}

// UI actions
document.getElementById("toggleChartBtn").addEventListener("click", ()=>{
  const box=document.getElementById("chartBox");
  const btn=document.getElementById("toggleChartBtn");
  const show = box.style.display==="none";
  box.style.display = show ? "block":"none";
  btn.textContent = show ? "Hide chart":"Show chart";
});
document.getElementById("refreshBtn").addEventListener("click", main);

// Start
main();
</script>
</body>
</html>
